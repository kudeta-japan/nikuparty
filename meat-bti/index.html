<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MEAT-BTI v7.5｜20問・6択（岐阜ローカル & 簡潔前提）</title>
<meta name="description" content="5問×4ページ＝全20問。岐阜ローカルの簡潔な前提つき。6段階（中立なし）・無作為順/左右入替・一貫性チェック。基本12タイプ＋シークレット『シャトーブリアン』。"/>

<!-- GA4（サイト共通：G-V39MNGQD5H） -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-V39MNGQD5H"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){ dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'G-V39MNGQD5H');
</script>

<style>
  :root{
    --bg:#090b10; --panel:#0f1219; --ink:#f5f8ff; --muted:#b7c3d6;
    --acc:#ff715b; --acc2:#ffd166; --bd:#1b2030; --shadow:0 10px 30px rgba(0,0,0,.35);
    --good:#35d19d; --warn:#ffd166; --blue:#59b3ff;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Meiryo",sans-serif;letter-spacing:.02em}
  .app{width:min(960px,100%);margin:0 auto;padding:24px}
  .card{background:var(--panel);border:1px solid var(--bd);border-radius:20px;box-shadow:var(--shadow);overflow:hidden}
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--bd)}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:36px;height:36px;border-radius:10px;background:conic-gradient(from 140deg,var(--acc),var(--acc2));display:grid;place-items:center;color:#111;font-weight:900}
  .title{font-weight:900}
  .wrap{padding:0}

  /* HERO（LPと同じ構成：背景写真＋暗幕） */
  .hero{position:relative;min-height:56vh;padding:40px 28px 26px;background:#000;overflow:hidden;border-bottom:1px solid var(--bd)}
  .hero-img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:brightness(.78) contrast(1.05)}
  .hero::after{content:"";position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.1) 0%, rgba(0,0,0,.55) 60%, rgba(0,0,0,.85) 100%)}
  .hero-inner{position:relative;z-index:1;display:grid;gap:18px}
  .eyebrow{display:inline-flex;gap:8px;align-items:center;background:rgba(255,255,255,.08);border:1px solid #222a3a;color:#dfe7f5;padding:6px 10px;border-radius:999px;font-size:12px}
  .h1{font-size:clamp(26px,5.6vw,40px);line-height:1.2;font-weight:900;margin:0}
  .lead{color:var(--muted);margin:0}
  .badges{display:flex;flex-wrap:wrap;gap:8px;margin-top:4px}
  .badge{background:#121829;border:1px solid #2a3245;color:#dfe7f5;border-radius:999px;padding:6px 10px;font-size:12px}
  .cta-row{display:flex;align-items:center;gap:12px;margin-top:8px;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid var(--bd);background:#151a23;color:var(--ink);padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer;transition:transform .06s ease, box-shadow .15s ease}
  .btn:hover{transform:translateY(-1px)}
  .btn.primary{background:linear-gradient(180deg,var(--acc),#ff4e36);color:#111;border:none;box-shadow:0 12px 26px rgba(255,113,91,.35)}
  .subnote{color:var(--muted);font-size:12px}
  .types{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px}
  @media(min-width:720px){.types{grid-template-columns:repeat(6,1fr)}}
  .type-chip{background:#121726;border:1px solid #2a3140;border-radius:12px;padding:10px 10px;text-align:center;font-weight:700;white-space:nowrap}

  /* QUIZ */
  .section{padding:16px}
  .q-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .q-index{font-weight:900}
  .bar{height:6px;background:#141721;border:1px solid var(--bd);border-radius:999px;overflow:hidden;width:220px}
  .bar>div{height:100%;width:0%;background:linear-gradient(90deg,var(--acc),var(--acc2))}
  .qgrid{display:grid;gap:12px}
  .qitem{background:#111522;border:1px solid #2a3140;border-radius:14px;padding:14px}
  .ctx{color:#e7ecf8;font-weight:700;font-size:clamp(14px,2.8vw,16px);margin:-2px 0 8px 0}
  .lr{display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:stretch;pointer-events:none}
  .side{background:#0f1522;border:1px solid #272f41;border-radius:12px;padding:10px;min-height:66px;display:flex;align-items:center;justify-content:center;text-align:center}
  .side b{font-size:clamp(14px,2.6vw,17px)}
  .scale{display:flex;gap:10px;justify-content:center;align-items:center;margin-top:10px}
  .dot{width:28px;height:28px;border-radius:999px;border:2px solid #39435a;background:#161b27;cursor:pointer;display:grid;place-items:center}
  .dot.small{width:22px;height:22px}
  .dot.big{width:32px;height:32px}
  .dot[data-side="L"].active{background:linear-gradient(180deg,#3aa1ff,#2677c8);border-color:#2b6fb6;box-shadow:0 0 0 4px rgba(63,155,255,.18)}
  .dot[data-side="R"].active{background:linear-gradient(180deg,#ff7a63,#ff5039);border-color:#e6422e;box-shadow:0 0 0 4px rgba(255,104,84,.18)}
  .dot:hover{transform:translateY(-1px)}
  .q-foot{display:flex;justify-content:space-between;align-items:center;margin-top:8px;color:var(--muted);font-size:12px}
  .pill{display:inline-block;padding:6px 12px;border-radius:999px;background:#131726;border:1px solid var(--bd);margin-right:6px}
  .disabled{opacity:.55;pointer-events:none}
  .progress-note{color:var(--muted);font-size:12px;text-align:center;margin-top:8px}

  /* RESULT */
  .result{display:grid;gap:16px}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}
  .r-card{background:#0f1219;border:1px solid var(--bd);border-radius:14px;padding:14px}
  .big{font-size:clamp(26px,6vw,34px);font-weight:900}
  .desc{margin-top:10px;line-height:1.9}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  footer{padding:10px 16px 16px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<main class="app">
  <div class="card">
    <header>
      <div class="brand"><div class="logo">🥩</div><div class="title">MEAT-BTI v7.5（20問・岐阜ローカル前提）</div></div>
      <button id="btn-start" class="btn primary" data-action="start">診断をはじめる</button>
    </header>

    <!-- START -->
    <section id="screen-start" class="hero">
      <!-- 追加：ヒーロー背景画像 -->
      <img src="mbti.jpg" alt="" class="hero-img" />
      <div class="hero-inner">
        <span class="eyebrow">✨ KU-DETA 限定 ・ 11/15</span>
        <h1 class="h1">肉好きのための性格診断。<br>あなたはどの <span style="color:#ffd166">“部位タイプ”</span>？</h1>
        <p class="lead">全20問。岐阜ローカルの<b>短い前提</b>付き／6段階スケール（中立なし）。味覚と食事シーンのクセから判定します。</p>
        <div class="badges">
          <span class="badge">6択 × 20問</span>
          <span class="badge">無作為順・左右入替</span>
          <span class="badge">一貫性チェック</span>
        </div>
        <div class="cta-row">
          <button class="btn primary" id="btn-start-2" data-action="start">診断をはじめる</button>
          <span class="subnote">※キーボード <b>1–6</b> でも選べます</span>
        </div>
        <div class="types" aria-label="12タイプ">
          <div class="type-chip">ヒレ</div><div class="type-chip">タン</div><div class="type-chip">イチボ</div><div class="type-chip">ランプ</div>
          <div class="type-chip">リブロース</div><div class="type-chip">サーロイン</div><div class="type-chip">ザブトン</div><div class="type-chip">カルビ</div>
          <div class="type-chip">ハラミ</div><div class="type-chip">シンシン</div><div class="type-chip">カイノミ</div><div class="type-chip">ミスジ</div>
        </div>
      </div>
    </section>

    <!-- QUIZ -->
    <div class="wrap">
      <section id="screen-quiz" class="section" hidden>
        <div class="q-head">
          <div class="q-index"><span id="page-now">1</span>/4ページ（<span id="q-answered">0</span>/20）</div>
          <div class="bar"><div id="bar"></div></div>
        </div>

        <div id="qgrid" class="qgrid"><!-- 5問がここに出る --></div>

        <div class="q-foot">
          <div>※左右カードは説明のみ（クリック不可）</div>
          <div style="display:flex;gap:10px">
            <button id="btn-next" class="btn primary disabled">次の5問へ</button>
          </div>
        </div>
        <div class="progress-note">丸いドットで選択。左（青）⇔右（赤）ほど強い。</div>
      </section>

      <!-- RESULT -->
      <section id="screen-result" class="section" hidden>
        <div class="result">
          <div class="big">診断結果</div>
          <div class="grid">
            <div class="r-card">
              <div><strong>あなたの部位タイプ</strong></div>
              <div style="margin-top:6px;font-size:22px;font-weight:900" id="r-type-name">—</div>
              <div class="mono" id="r-type-code" style="opacity:.8">R-F-K</div>
              <div style="margin-top:10px"><span class="pill" id="tag-texture">噛み応え</span><span class="pill" id="tag-flavor">塩派</span><span class="pill" id="tag-after">軽やか</span></div>
              <p class="desc" id="r-desc"></p>
            </div>
            <div class="r-card">
              <div><strong>相性No.1</strong></div>
              <div id="r-best" class="mono" style="margin-top:6px"></div>
            </div>
          </div>

          <div style="display:flex;justify-content:space-between;gap:10px">
            <button class="btn" id="btn-retry">最初から</button>
            <a class="btn primary" href="#" id="btn-export" download>結果をJSONで保存</a>
          </div>
        </div>
      </section>
    </div>

    <footer>© KU-DETA / ニクパーティ — MEAT-BTI v7.5</footer>
  </div>
</main>

<script>
/* ==== Question Bank（岐阜ローカル & 簡潔前提）20問 ==== */
const BANK = [
  {id:1,axis:"RL",ctx:"KU-DETAで最初の一皿。",a:"脂少なめで赤身を味わう",b:"サシのコクで満足したい"},
  {id:2,axis:"RL",ctx:"平日夜、岐阜駅近でサクッと。",a:"軽く終える",b:"しっかり満腹まで"},
  {id:3,axis:"RL",ctx:"同価格の赤身と霜降り。",a:"キレ重視（さっぱり）",b:"コク重視（濃厚）"},
  {id:19,axis:"RL",ctx:"名物カルビ vs 赤身名物を1皿。",a:"赤身を選ぶ",b:"名物カルビを選ぶ"},
  {id:4,axis:"RL",ctx:"店長の推し：ヒレ/タン or サーロイン/カルビ。",a:"ヒレ・タンに惹かれる",b:"サーロイン・カルビに惹かれる"},
  {id:5,axis:"TX",ctx:"カット指定OKのお店。",a:"歯切れ良い噛み応え",b:"とろける柔らかさ"},
  {id:6,axis:"TX",ctx:"焼き加減の希望は？",a:"薄切り・レア寄り",b:"厚切り・ミディアム以上"},
  {id:7,axis:"TX",ctx:"あなたが焼き担当。",a:"サッと火入れ",b:"しっかり火入れ"},
  {id:8,axis:"FL",ctx:"卓上は塩と特製ダレ。",a:"シンプル派（塩・レモン）",b:"ソース派（甘辛・ガリバタ等）"},
  {id:9,axis:"FL",ctx:"香りの演出も選べる。",a:"肉の香りを活かす",b:"ソース香で盛り上げる"},
  {id:10,axis:"FS",ctx:"七輪1台の少人数。",a:"強火で回転良く",b:"弱〜中火でじっくり"},
  {id:11,axis:"FS",ctx:"“コース or アラカルト”。",a:"テンポ良く次々",b:"ゆっくりコース"},
  {id:12,axis:"FS",ctx:"玉宮が混む金曜。",a:"他店へ移動する",b:"気に入れば腰を据える"},
  {id:13,axis:"KC",ctx:"最初の一皿。",a:"塩タン・王道から",b:"限定・変わり種から"},
  {id:14,axis:"KC",ctx:"4人でシェア注文。",a:"最初にまとめて段取り",b:"様子見で都度追加"},
  {id:20,axis:"KC",ctx:"今日はSNSにも上げる夜。",a:"味優先で選ぶ",b:"映え優先で選ぶ"},
  {id:15,axis:"KC",ctx:"会社メンバーも参加。",a:"マナー重視で食べる",b:"型に縛られず楽しむ"},
  {id:16,axis:"AF",ctx:"締めのタイミング。",a:"〆なし/軽めでOK",b:"ご飯・冷麺・デザートまで"},
  {id:17,axis:"AF",ctx:"最初の一杯。",a:"ハイボール/すっきり系",b:"甘め/濃い系も欲しい"},
  {id:18,axis:"AF",ctx:"21時、玉宮で二軒目あるかも。",a:"軽く続けたい",b:"ここで完結したい"},
];

function decorateBankRandomly(bank){return bank.map(q=>({...q,flip:Math.random()<0.5}))}
const OPP={R:"L",L:"R",F:"S",S:"F",K:"C",C:"K"};

/* 代表（相性計算） */
const CODE_REPR={
  "R-F-K":"ヒレ","R-F-C":"タン","R-S-K":"イチボ","R-S-C":"ランプ",
  "L-F-K":"リブロース","L-F-C":"サーロイン","L-S-K":"ザブトン","L-S-C":"カルビ"
};
/* 説明文（12＋CB） */
const DESCRIPTIONS={
  "ヒレ":"無駄のない上品さと芯の強さが共存するタイプ。情報を整理し、結論をすっきり出すのが得意。味わいはストレートに、素材勝負の一皿を好みます。",
  "タン":"さっぱり塩でキレ良く。テンポの良さと明るさで周囲をほぐすムードメイクが得意。直感が利き、判断もスピーディ。",
  "イチボ":"赤身の旨みを丁寧に味わう、調和型の通好み。控えめながら芯があり、空気を読みつつも要所で意見を言える人。",
  "ランプ":"探究心と柔軟さを兼ね備えた実験好き。低温や創作のように定番を一歩更新する工夫にワクワクします。",
  "リブロース":"王道リッチ派。厚みのある旨みと安心感を重視し、段取りよく皆を導ける頼れる人。",
  "サーロイン":"華やぎとサービス精神で場を盛り上げるムードメーカー。写真映えや“特製ソース”に心が躍るタイプ。",
  "ザブトン":"しっとり濃厚、噛むほどに広がるコク。こだわりは強いが押し付けず、丁寧に言葉を選びます。",
  "カルビ":"濃厚で甘辛の旨みを愛するリッチ派。サービス精神があり、人を巻き込むのが上手。",
  "ハラミ":"炭火と甘辛ダレが似合う、躍動感のある赤身派。歯ごたえとジューシーさのバランス派。",
  "シンシン":"上品な赤身のコクとキレを両立。無駄のない味設計を好む堅実派。",
  "カイノミ":"軽やかで繊維感が心地よい。脂の旨みは好きだが重さは抑えたいタイプ。",
  "ミスジ":"繊細なサシが入りつつ軽やか。やさしい口どけと上品な香りを好む丁寧さの人。",
  "シャトーブリアン":"質への強いこだわりを備えた“特選ヒレ”。量より質、完成度重視の希少タイプ。"
};

/* ==== State ==== */
const PAGE_SIZE=5, TOTAL_PAGES=4;
let QUESTIONS=[], page=0, responses={}, answeredCount=0, pageStartAt=0;
const counts={R:0,L:0,F:0,S:0,K:0,C:0,Q:0,M:0,Salt:0,Sauce:0,Light:0,Hearty:0};
const answers=[], rtimes=[], rl_items=[], fs_items=[], kc_items=[];
const el=id=>document.getElementById(id);
const screenStart=el('screen-start'), screenQuiz=el('screen-quiz'), screenResult=el('screen-result');
function showScreen(which){screenStart.hidden=which!=='start';screenQuiz.hidden=which!=='quiz';screenResult.hidden=which!=='result';}

/* ==== Flow ==== */
function start(){
  Object.keys(counts).forEach(k=>counts[k]=0);
  responses={}; answeredCount=0; page=0;
  answers.length=0; rtimes.length=0; rl_items.length=0; fs_items.length=0; kc_items.length=0;

  QUESTIONS=decorateBankRandomly([...BANK]).sort(()=>Math.random()-0.5);
  showScreen('quiz'); renderPage();
}
function renderPage(){
  el('page-now').textContent=page+1;
  el('q-answered').textContent=answeredCount;
  el('bar').style.width=((page)/TOTAL_PAGES*100)+'%';

  const startIdx=page*PAGE_SIZE;
  const slice=QUESTIONS.slice(startIdx, startIdx+PAGE_SIZE);

  const grid=el('qgrid'); grid.innerHTML='';
  slice.forEach((q)=>{
    const left=q.flip?q.b:q.a; const right=q.flip?q.a:q.b;
    const wrap=document.createElement('div'); wrap.className='qitem'; wrap.dataset.qid=q.id;
    wrap.innerHTML=`
      <div class="ctx">${q.ctx}</div>
      <div class="lr" aria-label="左右の比較文">
        <div class="side"><b>${left}</b></div>
        <div class="side"><b>${right}</b></div>
      </div>
      <div class="scale" role="radiogroup" aria-label="6段階選択">
        ${renderDots(q.id).join('')}
      </div>
    `;
    grid.appendChild(wrap);
  });

  setNextEnabled(slice.every(q=>responses[q.id]));

  grid.querySelectorAll('.dot').forEach(dot=>{
    dot.addEventListener('click', e=>{
      const qid = Number(e.currentTarget.closest('.qitem').dataset.qid);
      const uiVal = Number(e.currentTarget.dataset.val); // +3..-3
      selectDot(qid, uiVal, e.currentTarget);
    })
  });

  // 1..6 のキー割当（このページの“未回答”に順次入力）
  window.onkeydown=(e)=>{
    const map={'1':3,'2':2,'3':1,'4':-1,'5':-2,'6':-3};
    if(!(e.key in map)) return;
    for(const q of slice){
      if(!responses[q.id]){
        const qwrap=grid.querySelector(`[data-qid="${q.id}"]`);
        const target=qwrap.querySelector(`.dot[data-val="${map[e.key]}"]`);
        target && target.click(); break;
      }
    }
  };

  pageStartAt=performance.now();
}
function renderDots(qid){
  const tipsL=["左：とても近い","左：かなり近い","左：やや近い"];
  const tipsR=["右：やや近い","右：かなり近い","右：とても近い"];
  const valsL=[3,2,1], valsR=[-1,-2,-3];
  const cur=responses[qid]?.uiVal;

  const left=valsL.map((v,i)=>`
    <button class="dot ${i===0?'big':i===1?'':'small'} ${cur===v?'active':''}" data-side="L" data-val="${v}" title="${tipsL[i]}" aria-label="${tipsL[i]}"></button>
  `);
  const right=valsR.map((v,i)=>`
    <button class="dot ${i===2?'big':i===1?'':'small'} ${cur===v?'active':''}" data-side="R" data-val="${v}" title="${tipsR[i]}" aria-label="${tipsR[i]}"></button>
  `);
  return [...left, ...right];
}
function selectDot(qid, uiVal, btn){
  responses[qid] = responses[qid] || {};
  const firstTime = (responses[qid].uiVal === undefined);
  responses[qid].uiVal = uiVal;
  if(firstTime){
    responses[qid].ts = performance.now() - pageStartAt;
    answeredCount++; el('q-answered').textContent = answeredCount;
  }
  const wrap=btn.closest('.qitem');
  wrap.querySelectorAll('.dot').forEach(d=>d.classList.remove('active'));
  wrap.querySelector(`.dot[data-val="${uiVal}"]`).classList.add('active');

  const startIdx=page*PAGE_SIZE; const slice=QUESTIONS.slice(startIdx, startIdx+PAGE_SIZE);
  setNextEnabled(slice.every(q=>responses[q.id]));
}
function setNextEnabled(ok){el('btn-next').classList.toggle('disabled', !ok);}

/* ==== 集計（ページ確定）==== */
function applyPage(){
  const startIdx=page*PAGE_SIZE; const slice=QUESTIONS.slice(startIdx, startIdx+PAGE_SIZE);
  for(const q of slice){
    const r=responses[q.id]; if(!r) continue;
    const valForA=(q.flip?-r.uiVal:r.uiVal);  // +3..-3
    const towardA=Math.sign(valForA);
    const abs=Math.abs(valForA);
    const w=abs>=3?1.0:abs===2?0.7:0.4;

    answers.push({id:q.id,axis:q.axis,uiVal:r.uiVal,valForA,flipped:q.flip,ms:r.ts,ctx:q.ctx});
    rtimes.push(r.ts);

    const add=k=>counts[k]=(counts[k]||0)+w;
    if(q.axis==='RL'){ towardA>0 ? (add('R'), rl_items.push(1)) : (add('L'), rl_items.push(0)); }
    if(q.axis==='FS'){ towardA>0 ? (add('F'), fs_items.push(1)) : (add('S'), fs_items.push(0)); }
    if(q.axis==='KC'){ towardA>0 ? (add('K'), kc_items.push(1)) : (add('C'), kc_items.push(0)); }
    if(q.axis==='TX'){ towardA>0 ? add('Q') : add('M'); }
    if(q.axis==='FL'){ towardA>0 ? add('Salt') : add('Sauce'); }
    if(q.axis==='AF'){ towardA>0 ? add('Light') : add('Hearty'); }
  }
}

/* ==== ページ遷移 ==== */
document.getElementById('btn-next').addEventListener('click', ()=>{
  const btn = document.getElementById('btn-next');
  if(btn.classList.contains('disabled')) return;
  applyPage();
  if(page < TOTAL_PAGES-1){ page++; renderPage(); }
  else{ showResult(); }
});

/* ==== 判定ロジック ==== */
function strongEdge(axis){let e=0;for(const a of answers){if(a.axis!==axis)continue;if(a.valForA>=3)e++; else if(a.valForA<=-3)e--;}return e;}
function axisSeed(axis){let s=0;for(const a of answers){if(axis!=='ALL'&&a.axis!==axis)continue;s+=(a.id*31)+((a.uiVal+3)*13);}return s & 1;}
function decideAxis(A,B,AL,BL,relA,relB,strongAxis,seed){if(A>B)return AL;if(B>A)return BL;const wA=A+relA,wB=B+relB;if(wA>wB)return AL;if(wB>wA)return BL;const edge=strongEdge(strongAxis);if(edge>0)return AL;if(edge<0)return BL;return seed?BL:AL;}

function scoreHarami(c){ return 0.60*c.Sauce - 0.60*c.Salt + 0.30*c.Hearty - 0.30*c.Light + 0.20*c.M - 0.20*c.Q; }
function scoreMisuji(c){ return 0.70*c.M - 0.70*c.Q + 0.20*c.Salt - 0.20*c.Sauce + 0.10*c.Light - 0.10*c.Hearty; }
function scoreShinshin(c){ return 0.55*c.Q - 0.55*c.M + 0.25*c.Light - 0.25*c.Hearty + 0.20*c.Salt - 0.20*c.Sauce; }
function scoreKainomi(c){ return 0.60*c.Q - 0.60*c.M + 0.30*c.Salt - 0.30*c.Sauce + 0.10*c.Light - 0.10*c.Hearty; }
function pickSubtype(code,c){
  switch(code){
    case 'R-F-K': return 'ヒレ';
    case 'R-F-C': return (scoreHarami(c)>0 ? 'ハラミ':'タン');
    case 'R-S-K': return (scoreMisuji(c)>0 ? 'ミスジ':'イチボ');
    case 'R-S-C': return 'ランプ';
    case 'L-F-K': return (scoreShinshin(c)>0 ? 'シンシン':'リブロース');
    case 'L-F-C': return 'サーロイン';
    case 'L-S-K': return 'ザブトン';
    case 'L-S-C': return (scoreKainomi(c)>0 ? 'カイノミ':'カルビ');
    default: return 'ヒレ';
  }
}
function computeResult(){
  const R=counts.R,L=counts.L,F=counts.F,S=counts.S,K=counts.K,C=counts.C,Q=counts.Q,M=counts.M,Salt=counts.Salt,Sauce=counts.Sauce,Light=counts.Light,Hearty=counts.Hearty;
  const R_adj=(Q>=2?1:0)+(Salt>=2?1:0)+(Light>=2?1:0);
  const L_adj=(M>=2?1:0)+(Sauce>=2?1:0)+(Hearty>=2?1:0);
  const Rf=R+R_adj, Lf=L+L_adj;

  const RL=decideAxis(Rf,Lf,'R','L',0.60*Q+0.25*Salt+0.15*Light,0.60*M+0.25*Sauce+0.15*Hearty,'RL',axisSeed('RL'));
  const FS=decideAxis(F,S,'F','S',0.50*Light+0.30*Salt+0.20*Q,0.50*Hearty+0.30*Sauce+0.20*M,'FS',axisSeed('FS'));
  const KC=decideAxis(K,C,'K','C',0.45*Salt+0.25*Light+0.15*Q,0.45*Sauce+0.25*Hearty+0.15*M,'KC',axisSeed('KC'));

  const code=`${RL}-${FS}-${KC}`;
  let baseName=pickSubtype(code,{Q,M,Salt,Sauce,Light,Hearty});
  let name=baseName;

  // シークレット：シャトーブリアン（2%前後）
  const dRL=Math.max(0,(RL==='R'?Rf-Lf:Lf-Rf));
  const dFS=Math.max(0,(FS==='F'?F-S:S-F));
  const dKC=Math.max(0,(KC==='K'?K-C:C-K));
  const isCB=(code==='R-F-K')&&(baseName==='ヒレ')&&(M>=2 && Salt>=2 && Light>=2)&&(dRL>=1.3 && dFS>=1.1 && dKC>=1.0)&&(strongEdge('RL')>0)&&(axisSeed('ALL')===1);
  if(isCB) name='シャトーブリアン';

  const tagTexture=(Q>=M)?'噛み応え':'とろけ';
  const tagFlavor =(Salt>=Sauce)?'塩派':'ソース派';
  const tagAfter  =(Light>=Hearty)?'軽やか':'満足';

  return {code,baseName,name,R_base:R,L_base:L,F,S,K,C,Q,M,Salt,Sauce,Light,Hearty,R_adj,L_adj,Rf,Lf,tagTexture,tagFlavor,tagAfter};
}

/* 相性候補生成 */
function parseCode(code){const [a,b,c]=code.split('-');return {RL:a,FS:b,KC:c};}
function allTypeCodes(){return Object.keys(CODE_REPR);}
function bestMatch(code){
  const mine=parseCode(code);let best=null,bestScore=-1;
  for(const t of allTypeCodes()){
    if(t===code) continue;
    const other=parseCode(t);
    let opp=0,same=0;
    if(other.RL===OPP[mine.RL])opp++;
    if(other.FS===OPP[mine.FS])opp++;
    if(other.KC===OPP[mine.KC])opp++;
    if(other.RL===mine.RL)same++;
    if(other.FS===mine.FS)same++;
    if(other.KC===mine.KC)same++;
    const score=(opp>=2)?opp*10:(opp*10+same);
    if(score>bestScore){bestScore=score;best=t;}
  }
  return best;
}

/* ==== 結果表示 ==== */
function showResult(){
  el('bar').style.width='100%';
  const r=computeResult(); showScreen('result');
  el('r-type-name').textContent=r.name;
  el('r-type-code').textContent=r.code;
  el('tag-texture').textContent=r.tagTexture;
  el('tag-flavor').textContent=r.tagFlavor;
  el('tag-after').textContent=r.tagAfter;
  el('r-desc').textContent=DESCRIPTIONS[r.name]||'';
  const bm=bestMatch(r.code); const repr=CODE_REPR[bm]||bm;
  el('r-best').textContent=bm?`${repr}（${bm}）`:'—';

  // JSONエクスポート
  const payload={type:{baseCode:r.code,baseName:r.baseName,displayName:r.name},tags:{texture:r.tagTexture,flavor:r.tagFlavor,after:r.tagAfter},counts:{R:r.R_base,L:r.L_base,F:r.F,S:r.S,K:r.K,C:r.C,Q:r.Q,M:r.M,Salt:r.Salt,Sauce:r.Sauce,Light:r.Light,Hearty:r.Hearty},answers,generatedAt:new Date().toISOString()};
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=el('btn-export'); a.href=url; a.download=`MEAT-BTI_${r.code}.json`;
}

/* Start / Retry */
addEventListener('click',(ev)=>{ const t=ev.target.closest('#btn-start,#btn-start-2'); if(!t) return; ev.preventDefault(); start(); });
const retry=document.getElementById('btn-retry'); if(retry) retry.addEventListener('click',()=>{showScreen('start')});
</script>
</body>
</html>
