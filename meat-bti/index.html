<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MEAT-BTI v7.2ï½œåŸºæœ¬12ã‚¿ã‚¤ãƒ—ï¼‹ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆCBï¼ˆæ™‚é–“åˆ¶é™ãªã—ï¼‰</title>
  <meta name="description" content="5æ®µéšÃ—18å•ã€‚ç„¡ä½œç‚ºé †ãƒ»å·¦å³å…¥æ›¿ãƒ»ä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯ã€‚åŸºæœ¬12ã‚¿ã‚¤ãƒ—ï¼ˆãƒ’ãƒ¬/ã‚¿ãƒ³/ã‚¤ãƒãƒœ/ãƒ©ãƒ³ãƒ—/ãƒªãƒ–ãƒ­ãƒ¼ã‚¹/ã‚µãƒ¼ãƒ­ã‚¤ãƒ³/ã‚¶ãƒ–ãƒˆãƒ³/ã‚«ãƒ«ãƒ“/ãƒãƒ©ãƒŸ/ã‚·ãƒ³ã‚·ãƒ³/ã‚«ã‚¤ãƒãƒŸ/ãƒŸã‚¹ã‚¸ï¼‰ï¼‹ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã€ã‚·ãƒ£ãƒˆãƒ¼ãƒ–ãƒªã‚¢ãƒ³ã€ã€‚æ™‚é–“åˆ¶é™ãªã—ã€‚"/>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-V39MNGQD5H"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-V39MNGQD5H');
  </script>

  <style>
    :root{
      --bg:#090b10; --panel:#0f1219; --ink:#f5f8ff; --muted:#b7c3d6;
      --acc:#ff715b; --acc2:#ffd166; --bd:#1b2030; --shadow:0 10px 30px rgba(0,0,0,.35);
      --good:#35d19d; --warn:#ffd166; --blue:#59b3ff;
      --grad: radial-gradient(1200px 600px at 10% -10%, rgba(255,113,91,.25), transparent 40%),
              radial-gradient(1200px 600px at 110% 110%, rgba(255,209,102,.2), transparent 40%),
              linear-gradient(180deg,#0a0d14,#0b0e15 50%, #0d111a);
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Meiryo",sans-serif;letter-spacing:.02em}
    .app{width:min(960px,100%);margin:0 auto;padding:24px}
    .card{background:var(--panel);border:1px solid var(--bd);border-radius:20px;box-shadow:var(--shadow);overflow:hidden}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--bd)}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:36px;height:36px;border-radius:10px;background:conic-gradient(from 140deg,var(--acc),var(--acc2));display:grid;place-items:center;color:#111;font-weight:900}
    .title{font-weight:900}
    .wrap{padding:0}

    /* ====== HERO ====== */
    .hero{position:relative;background:var(--grad);padding:40px 28px 26px;overflow:hidden}
    .hero-inner{display:grid;gap:18px;position:relative;z-index:1}
    .eyebrow{display:inline-flex;gap:8px;align-items:center;background:rgba(255,255,255,.08);border:1px solid #222a3a;color:#dfe7f5;padding:6px 10px;border-radius:999px;font-size:12px}
    .spark{filter:drop-shadow(0 2px 8px rgba(255,209,102,.35))}
    .h1{font-size:clamp(26px,5.6vw,40px);line-height:1.2;font-weight:900;margin:0}
    .lead{color:var(--muted);margin:0}
    .badges{display:flex;flex-wrap:wrap;gap:8px;margin-top:4px}
    .badge{background:#121829;border:1px solid #2a3245;color:#dfe7f5;border-radius:999px;padding:6px 10px;font-size:12px}
    .cta-row{display:flex;align-items:center;gap:12px;margin-top:8px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--bd);background:#151a23;color:var(--ink);padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer;transition:transform .06s ease, box-shadow .15s ease}
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:linear-gradient(180deg,var(--acc),#ff4e36);color:#111;border:none;box-shadow:0 12px 26px rgba(255,113,91,.35)}
    .subnote{color:var(--muted);font-size:12px}
    .types{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px}
    @media(min-width:720px){.types{grid-template-columns:repeat(6,1fr)}}
    .type-chip{background:#121726;border:1px solid #2a3140;border-radius:12px;padding:10px 10px;text-align:center;font-weight:700;white-space:nowrap}
    .float{display:none !important;} /* è£…é£¾OFF */

    /* ---- QUIZ ---- */
    .section{padding:16px}
    .q-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .q-index{font-weight:900}
    .progress{display:flex;align-items:center;gap:10px}
    .bar{height:6px;background:#141721;border:1px solid var(--bd);border-radius:999px;overflow:hidden;width:200px}
    .bar>div{height:100%;width:0%;background:linear-gradient(90deg,var(--acc),var(--acc2))}
    .timer{display:none} /* æ™‚é–“UIéè¡¨ç¤º */

    .q-main{margin-top:12px}
    .q-title{font-size:clamp(18px,3.6vw,24px);font-weight:900;text-align:center;margin:0;color:var(--ink)}
    .ab{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;align-items:stretch}
    .side{background:#121726;border:1px solid #2a3140;border-radius:16px;padding:14px;min-height:84px;display:flex;align-items:center;justify-content:center;text-align:center;pointer-events:none} /* â† ã‚¯ãƒªãƒƒã‚¯ä¸å¯ */
    .side b{font-size:clamp(15px,2.8vw,18px)}
    .side small{display:block;color:var(--muted);margin-top:6px}
    .ab.glow-left .left{border-color:var(--blue);box-shadow:0 0 0 3px rgba(89,179,255,.15) inset}
    .ab.glow-right .right{border-color:var(--acc);box-shadow:0 0 0 3px rgba(255,107,87,.12) inset}

    .opt5{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-top:10px}
    .opt5 .opt{background:#151a27;border:1px solid #2a3140;border-radius:12px;padding:14px 10px;font-size:clamp(13px,2.2vw,15px);line-height:1.3;cursor:pointer;transition:transform .05s ease,border-color .12s ease,background .12s ease;color:var(--ink)}
    .opt5 .opt:hover{transform:translateY(-1px);border-color:#364158;background:#182033}
    .opt5 .opt.l{border-left:3px solid var(--blue)}
    .opt5 .opt.r{border-right:3px solid var(--acc)}
    @media (max-width:560px){.opt5{grid-template-columns:1fr 1fr;grid-auto-rows:minmax(46px,auto)}}
    .progress-note{color:var(--muted);font-size:12px;text-align:center;margin-top:8px}

    /* ---- RESULT ---- */
    .result{display:grid;gap:16px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}
    .r-card{background:#0f1219;border:1px solid var(--bd);border-radius:14px;padding:14px}
    .big{font-size:clamp(26px,6vw,34px);font-weight:900}
    .pill{display:inline-block;padding:6px 12px;border-radius:999px;background:#131726;border:1px solid var(--bd);margin-right:6px}
    .desc{margin-top:10px;line-height:1.9}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    footer{padding:10px 16px 16px;color:var(--muted);font-size:12px}

    .meter{height:10px;background:#141721;border:1px solid var(--bd);border-radius:999px;overflow:hidden}
    .meter>div{height:100%;width:0%;background:linear-gradient(90deg,var(--good),var(--warn))}
    .hint{color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <main class="app">
    <div class="card">
      <header>
        <div class="brand"><div class="logo">ğŸ¥©</div><div class="title">MEAT-BTI v7.2ï¼ˆ12ã‚¿ã‚¤ãƒ—ï¼‹ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆCBï¼‰</div></div>
        <button id="btn-start" class="btn primary" data-action="start">è¨ºæ–­ã‚’ã¯ã˜ã‚ã‚‹</button>
      </header>

      <!-- ===== HERO / START ===== -->
      <section id="screen-start" class="hero">
        <div class="hero-inner">
          <span class="eyebrow"><span class="spark">âœ¨</span> KU-DETA é™å®š ãƒ» 11/15</span>
          <h1 class="h1">è‚‰å¥½ãã®ãŸã‚ã®æ€§æ ¼è¨ºæ–­ã€‚<br/>ã‚ãªãŸã¯ã©ã® <span style="color:var(--acc2)">â€œéƒ¨ä½ã‚¿ã‚¤ãƒ—â€</span>ï¼Ÿ</h1>
          <p class="lead">åŸºæœ¬12ã‚¿ã‚¤ãƒ—ï¼‹ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã€‚<b>æ™‚é–“åˆ¶é™ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</b>5æ®µéšÃ—18å•ã§ã€å‘³è¦šã¨é£Ÿäº‹ã‚·ãƒ¼ãƒ³ã®ã‚¯ã‚»ã‹ã‚‰åˆ¤å®šã€‚ç›¸æ€§No.1ã‚¿ã‚¤ãƒ—ã‚‚åˆ†ã‹ã‚Šã¾ã™ã€‚</p>
          <div class="badges">
            <span class="badge">5æŠ Ã— 18å•</span>
            <span class="badge">ç„¡ä½œç‚ºé †ãƒ»å·¦å³å…¥æ›¿</span>
            <span class="badge">ä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯</span>
          </div>
          <div class="cta-row">
            <button class="btn primary" id="btn-start-2" data-action="start">è¨ºæ–­ã‚’ã¯ã˜ã‚ã‚‹</button>
            <span class="subnote">â€»ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ <b>1â€“5</b> ã§ã‚‚é¸ã¹ã¾ã™</span>
          </div>

          <div class="section" style="padding:0;margin-top:6px">
            <div class="types" aria-label="12ã‚¿ã‚¤ãƒ—">
              <div class="type-chip">ãƒ’ãƒ¬</div><div class="type-chip">ã‚¿ãƒ³</div><div class="type-chip">ã‚¤ãƒãƒœ</div><div class="type-chip">ãƒ©ãƒ³ãƒ—</div>
              <div class="type-chip">ãƒªãƒ–ãƒ­ãƒ¼ã‚¹</div><div class="type-chip">ã‚µãƒ¼ãƒ­ã‚¤ãƒ³</div><div class="type-chip">ã‚¶ãƒ–ãƒˆãƒ³</div><div class="type-chip">ã‚«ãƒ«ãƒ“</div>
              <div class="type-chip">ãƒãƒ©ãƒŸ</div><div class="type-chip">ã‚·ãƒ³ã‚·ãƒ³</div><div class="type-chip">ã‚«ã‚¤ãƒãƒŸ</div><div class="type-chip">ãƒŸã‚¹ã‚¸</div>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== QUIZ ===== -->
      <div class="wrap" id="stage">
        <section id="screen-quiz" class="section" hidden>
          <div class="q-head">
            <div class="q-index"><span id="q-counter">1</span>/<span id="q-total">18</span></div>
            <div class="progress">
              <div class="bar"><div id="bar"></div></div>
              <div class="hint">æ™‚é–“åˆ¶é™ãªã—</div>
            </div>
          </div>

          <div class="q-main">
            <p class="q-title" id="q-title">ã‚ãªãŸã¯ã©ã¡ã‚‰ã«è¿‘ã„ï¼Ÿ</p>
            <div class="ab" id="ab">
              <div class="side left" id="ab-left"><b>â€”</b><small>â† å·¦å¯„ã‚Š</small></div>
              <div class="side right" id="ab-right"><b>â€”</b><small>å³å¯„ã‚Š â†’</small></div>
            </div>
            <div class="opt5">
              <button class="opt l" id="btn-1" data-val="2">â¬… å¼·ãå·¦</button>
              <button class="opt l" id="btn-2" data-val="1">â¬… ã‚„ã‚„å·¦</button>
              <button class="opt"  id="btn-3" data-val="0">ã©ã¡ã‚‰ã§ã‚‚ãªã„</button>
              <button class="opt r" id="btn-4" data-val="-1">ã‚„ã‚„å³ â¡</button>
              <button class="opt r" id="btn-5" data-val="-2">å¼·ãå³ â¡</button>
            </div>
          </div>
          <div class="progress-note">â€»å·¦å³ã‚«ãƒ¼ãƒ‰ã¯ã‚¯ãƒªãƒƒã‚¯ã§ãã¾ã›ã‚“ï¼ˆ5ã¤ã®ãƒœã‚¿ãƒ³ã®ã¿æœ‰åŠ¹ï¼‰ã€‚</div>
        </section>

        <!-- RESULT -->
        <section id="screen-result" class="section" hidden>
          <div class="result">
            <div class="big" id="r-title">è¨ºæ–­çµæœ</div>
            <div class="grid">
              <div class="r-card">
                <div><strong>ã‚ãªãŸã®éƒ¨ä½ã‚¿ã‚¤ãƒ—</strong></div>
                <div style="margin-top:6px;font-size:22px;font-weight:900" id="r-type-name">â€”</div>
                <div class="mono" id="r-type-code" style="opacity:.8">R-F-K</div>
                <div style="margin-top:10px"><span class="pill" id="tag-texture">å™›ã¿å¿œãˆ</span><span class="pill" id="tag-flavor">å¡©æ´¾</span><span class="pill" id="tag-after">è»½ã‚„ã‹</span></div>
                <p class="desc" id="r-desc"></p>
              </div>
              <div class="r-card">
                <div><strong>ç›¸æ€§No.1</strong></div>
                <div id="r-best" class="mono" style="margin-top:6px"></div>
              </div>
            </div>

            <div class="r-card">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
                <strong>ä¿¡é ¼åº¦</strong>
                <button class="btn" id="btn-copy">çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
              </div>
              <div style="display:grid;gap:8px;margin-top:8px">
                <div>ç·åˆï¼š<span id="conf-overall-text">â€”</span>
                  <div class="meter"><div id="conf-overall" style="width:0%"></div></div>
                </div>
                <div>R/Lï¼š<span id="conf-rl-text">â€”</span>
                  <div class="meter"><div id="conf-rl" style="width:0%"></div></div>
                </div>
                <div>F/Sï¼š<span id="conf-fs-text">â€”</span>
                  <div class="meter"><div id="conf-fs" style="width:0%"></div></div>
                </div>
                <div>K/Cï¼š<span id="conf-kc-text">â€”</span>
                  <div class="meter"><div id="conf-kc" style="width:0%"></div></div>
                </div>
                <div class="hint" id="quality-hints"></div>
              </div>
            </div>

            <div class="r-card">
              <strong>è©³ç´°ï¼ˆé›†è¨ˆå€¤ï¼‰</strong>
              <pre class="mono" id="r-detail" style="white-space:pre-wrap;margin-top:8px;color:var(--muted)"></pre>
            </div>
            <div style="display:flex;justify-content:space-between;gap:10px">
              <button class="btn" id="btn-retry">æœ€åˆã‹ã‚‰</button>
              <a class="btn primary" href="#" id="btn-export" download>çµæœã‚’JSONã§ä¿å­˜</a>
            </div>
          </div>
        </section>
      </div>
      <footer>Â© KU-DETA / ãƒ‹ã‚¯ãƒ‘ãƒ¼ãƒ†ã‚£ â€” MEAT-BTI v7.2</footer>
    </div>
  </main>

<script>
/* --------------- Question Bankï¼ˆå‘³9ï¼‹ã‚·ãƒ¼ãƒ³9ï¼‰ --------------- */
const BANK = [
  // â”€â”€ å‘³ã®å—œå¥½ï¼ˆ9å•ï¼‰â”€â”€
  {id:1,  axis:"RL", a:"è„‚å°‘ãªã‚ã§èµ¤èº«ã®æ—¨ã¿ã‚’å‘³ã‚ã„ãŸã„", b:"ã‚µã‚·ã®å…¥ã£ãŸã‚³ã‚¯ã§æº€è¶³ã—ãŸã„"},
  {id:2,  axis:"RL", a:"é£Ÿå¾Œã¯è»½ã‚„ã‹ã«çµ‚ãˆãŸã„",           b:"ã—ã£ã‹ã‚Šæº€è…¹ãƒ»ä½™éŸ»ã‚’æ¥½ã—ã¿ãŸã„"},
  {id:3,  axis:"RL", a:"å‘³ã¯ã‚­ãƒ¬é‡è¦–ï¼ˆã•ã£ã±ã‚Šï¼‰",         b:"å‘³ã¯ã‚³ã‚¯é‡è¦–ï¼ˆæ¿ƒåšï¼‰"},
  {id:4,  axis:"RL", a:"ãƒ’ãƒ¬ã‚„ã‚¿ãƒ³ã«æƒ¹ã‹ã‚Œã‚‹",             b:"ã‚µãƒ¼ãƒ­ã‚¤ãƒ³ã‚„ã‚«ãƒ«ãƒ“ã«æƒ¹ã‹ã‚Œã‚‹"},
  // TXï¼ˆA=Q=å™›ã¿å¿œãˆã€B=M=ã¨ã‚ã‘ï¼‰
  {id:5,  axis:"TX", a:"æ­¯åˆ‡ã‚Œã‚ˆãå™›ã‚€ã»ã©æ—¨ã„é£Ÿæ„ŸãŒå¥½ã", b:"ã¨ã‚ã‘ã‚‹æŸ”ã‚‰ã‹ã•ãŒå¥½ã"},
  {id:6,  axis:"TX", a:"è–„åˆ‡ã‚Šãƒ»ãƒ¬ã‚¢å¯„ã‚ŠãŒå¥½ã¿",           b:"åšåˆ‡ã‚Šãƒ»ãƒŸãƒ‡ã‚£ã‚¢ãƒ ã€œã‚¦ã‚§ãƒ«ãŒå®‰å¿ƒ"},
  {id:7,  axis:"TX", a:"ç«ã¯é€šã—ã™ããšã‚µãƒƒã¨",             b:"ã—ã£ã‹ã‚Šç«å…¥ã‚Œã—ã¦è½ã¡ç€ã‹ã›ãŸã„"},
  // FLï¼ˆA=Saltã€B=Sauceï¼‰
  {id:8,  axis:"FL", a:"ãƒ¬ãƒ¢ãƒ³ãƒ»å¡©ãƒ»ã‚ã•ã³ãªã©ã‚·ãƒ³ãƒ—ãƒ«æ´¾", b:"ç”˜è¾›ãƒ€ãƒ¬/ã‚¬ãƒªãƒã‚¿/ãƒãƒ¼ã‚ºãªã©ã‚½ãƒ¼ã‚¹æ´¾"},
  {id:9,  axis:"FL", a:"è‚‰æœ¬æ¥ã®é¦™ã‚Šã‚’æ´»ã‹ã—ãŸã„",         b:"ã‚½ãƒ¼ã‚¹ã®é¦™ã‚Šã‚„æ¼”å‡ºã§ç››ã‚Šä¸Šã’ãŸã„"},
  // â”€â”€ é£Ÿã¹ã‚‹â€œã‚·ãƒ¼ãƒ³â€ã®æŒ¯ã‚‹èˆã„ï¼ˆ9å•ï¼‰â”€â”€
  {id:10, axis:"FS", a:"å¼·ç«ã§ã‚µãƒƒã¨ç„¼ã„ã¦å›è»¢è‰¯ãé£Ÿã¹ãŸã„", b:"å¼±ã€œä¸­ç«ã§ã˜ã£ãã‚Šè‚²ã¦ã¦é£Ÿã¹ãŸã„"},
  {id:11, axis:"FS", a:"æ–™ç†ã¯ãƒ†ãƒ³ãƒè‰¯ãæ¬¡ã€…å‡ºã¦ãã‚‹ã¨å¬‰ã—ã„", b:"ã‚³ãƒ¼ã‚¹ã§ã‚†ã£ãã‚Šå‡ºã¦ãã‚‹æ–¹ãŒå¬‰ã—ã„"},
  {id:12, axis:"FS", a:"æ··ã‚“ã§ã„ãŸã‚‰æ¬¡ã®åº—ã¸ç§»ã‚‹ã‚¿ã‚¤ãƒ—",     b:"å¸­ãŒæ°—ã«å…¥ã‚Œã°ä¸€è»’ã§è…°ã‚’æ®ãˆã‚‹"},
  {id:13, axis:"KC", a:"ã¾ãšã¯å®šç•ªã®å¡©ã‚¿ãƒ³ãƒ»ç‹é“ã‚«ãƒƒãƒˆã‹ã‚‰",   b:"ãã®åº—ã®é™å®š/å¤‰ã‚ã‚Šç¨®ã‚’å…ˆã«è©¦ã—ãŸã„"},
  {id:14, axis:"KC", a:"æ³¨æ–‡ã¯æœ€åˆã«ã¾ã¨ã‚ã¦æ®µå–ã‚Šè‰¯ã",       b:"æ§˜å­ã‚’è¦‹ãªãŒã‚‰ãã®éƒ½åº¦è¿½åŠ ã—ãŸã„"},
  {id:15, axis:"KC", a:"é£Ÿã¹æ–¹ã‚„ãƒãƒŠãƒ¼ã¯ãã£ã¡ã‚Šå®ˆã‚ŠãŸã„",     b:"å‹ã«ç¸›ã‚‰ã‚Œãšæ¥½ã—ãé£Ÿã¹ã‚‰ã‚Œã‚Œã°OK"},
  {id:16, axis:"AF", a:"ã€†ã¯ãªã—/ã‚¹ãƒ¼ãƒ—ç¨‹åº¦ã§ååˆ†",            b:"ã€†ã¯ã”é£¯ãƒ»å†·éººãƒ»ãƒ‡ã‚¶ãƒ¼ãƒˆã¾ã§ã—ã£ã‹ã‚Š"},
  {id:17, axis:"AF", a:"ãƒ‰ãƒªãƒ³ã‚¯ã¯ãƒã‚¤ãƒœãƒ¼ãƒ«/ã™ã£ãã‚Šç³»",      b:"ç”˜ã‚ã‚«ã‚¯ãƒ†ãƒ«ã‚„æ¿ƒã„ãƒ‰ãƒªãƒ³ã‚¯ã‚‚æ¬²ã—ã„"},
  {id:18, axis:"AF", a:"é£Ÿå¾Œã¯äºŒè»’ç›®ã§è»½ãç¶šã‘ãŸã„",            b:"ã“ã®åº—ã§å®Œçµã—ã¦æº€è…¹ã§ç· ã‚ãŸã„"}
];

function decorateBankRandomly(bank){return bank.map(q=>({...q,flip:Math.random()<0.5}));}
const OPP={R:"L",L:"R",F:"S",S:"F",K:"C",C:"K"};

/* --- ä»£è¡¨åï¼ˆç›¸æ€§è¨ˆç®—ã®ç›¸æ‰‹å´ã«ä½¿ã†æ—¢å®šåï¼š8ã‚³ãƒ¼ãƒ‰â†’ä»£è¡¨ï¼‰ --- */
const CODE_REPR={
  "R-F-K":"ãƒ’ãƒ¬","R-F-C":"ã‚¿ãƒ³","R-S-K":"ã‚¤ãƒãƒœ","R-S-C":"ãƒ©ãƒ³ãƒ—",
  "L-F-K":"ãƒªãƒ–ãƒ­ãƒ¼ã‚¹","L-F-C":"ã‚µãƒ¼ãƒ­ã‚¤ãƒ³","L-S-K":"ã‚¶ãƒ–ãƒˆãƒ³","L-S-C":"ã‚«ãƒ«ãƒ“"
};

/* --- 12ã‚¿ã‚¤ãƒ— èª¬æ˜ --- */
const DESCRIPTIONS={
  "ãƒ’ãƒ¬":"ç„¡é§„ã®ãªã„ä¸Šå“ã•ã¨èŠ¯ã®å¼·ã•ãŒå…±å­˜ã™ã‚‹ã‚¿ã‚¤ãƒ—ã€‚æƒ…å ±ã‚’æ•´ç†ã—ã€çµè«–ã‚’ã™ã£ãã‚Šå‡ºã™ã®ãŒå¾—æ„ã€‚å‘³ã‚ã„ã¯ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆã«ã€ç´ æå‹è² ã®ä¸€çš¿ã‚’å¥½ã¿ã¾ã™ã€‚ä¼šè©±ã§ã‚‚ç›¸æ‰‹ã®è©±ã‚’ä¸å¯§ã«æ‹¾ã„ã€ä½™ç™½ã‚’æ´»ã‹ã—ã¦æ·±ã‚ã‚‹ã®ãŒä¸Šæ‰‹ã€‚åˆå¯¾é¢ã§ã¯è³ªå•ã‚’ä¸€ã¤ãšã¤æŠ•ã’ã€å…±é€šç‚¹ãŒè¦‹ã¤ã‹ã‚‹ã¨ä¸€æ°—ã«è·é›¢ãŒç¸®ã¿ã¾ã™ã€‚",
  "ã‚¿ãƒ³":"ã•ã£ã±ã‚Šå¡©ã§ã‚­ãƒ¬è‰¯ãã€‚ãƒ†ãƒ³ãƒã®è‰¯ã•ã¨æ˜ã‚‹ã•ã§å‘¨å›²ã‚’ã»ãã™ãƒ ãƒ¼ãƒ‰ãƒ¡ã‚¤ã‚¯ãŒå¾—æ„ã€‚ç›´æ„ŸãŒåˆ©ãã€åˆ¤æ–­ã‚‚ã‚¹ãƒ”ãƒ¼ãƒ‡ã‚£ã€‚çŸ­ã„ã‚­ãƒ£ãƒƒãƒãƒœãƒ¼ãƒ«ã§ä¼šè©±ã‚’å›ã—ã€ä¹¾æ¯ã®å·ä»¤å½¹ã«ã‚‚å‘ã„ã¦ã„ã¾ã™ã€‚ã¾ãšã¯ã‚„ã£ã¦ã¿ã‚‹ç²¾ç¥ã§ã€æ–°ã—ã„äººã¨ã‚‚ã™ãè·é›¢ã‚’ç¸®ã‚ã‚‰ã‚Œã¾ã™ã€‚",
  "ã‚¤ãƒãƒœ":"èµ¤èº«ã®æ—¨ã¿ã‚’ä¸å¯§ã«å‘³ã‚ã†ã€èª¿å’Œå‹ã®é€šå¥½ã¿ã€‚æ§ãˆã‚ãªãŒã‚‰èŠ¯ãŒã‚ã‚Šã€ç©ºæ°—ã‚’èª­ã¿ã¤ã¤ã‚‚è¦æ‰€ã§æ„è¦‹ã‚’è¨€ãˆã‚‹äººã€‚æ´¾æ‰‹ã•ã‚ˆã‚Šä½™éŸ»ãŒæ®‹ã‚‹ã‚¿ã‚¤ãƒ—ã€‚ä¾¡å€¤è¦³ã®è¿‘ã„ç›¸æ‰‹ã¨é•·æœŸçš„ãªé–¢ä¿‚ã‚’ç¯‰ãã‚„ã™ã„ã€‚",
  "ãƒ©ãƒ³ãƒ—":"æ¢ç©¶å¿ƒã¨æŸ”è»Ÿã•ã‚’å…¼ã­å‚™ãˆãŸå®Ÿé¨“å¥½ãã€‚ä½æ¸©ã‚„å‰µä½œã®ã‚ˆã†ã«å®šç•ªã‚’ä¸€æ­©æ›´æ–°ã™ã‚‹å·¥å¤«ã«ãƒ¯ã‚¯ãƒ¯ã‚¯ã—ã¾ã™ã€‚ç‰©é™ã‹ã§ã‚‚ä¸­èº«ã¯ç†±ã„è·äººæ°—è³ªã§ã€è©¦é£Ÿã‚„å°ã•ãªä½“é¨“ã‚’å…±æœ‰ã™ã‚‹ã¨ä¼šè©±ãŒå¼¾ã¿ã¾ã™ã€‚",
  "ãƒªãƒ–ãƒ­ãƒ¼ã‚¹":"ç‹é“ãƒªãƒƒãƒæ´¾ã€‚åšã¿ã®ã‚ã‚‹æ—¨ã¿ã¨å®‰å¿ƒæ„Ÿã‚’é‡è¦–ã—ã€æ®µå–ã‚Šã‚ˆãçš†ã‚’å°ã‘ã‚‹é ¼ã‚Œã‚‹äººã€‚æ´¾æ‰‹ã•ã‚ˆã‚Šæº€è¶³åº¦ã§è©•ä¾¡ã€‚ä¼šè©±ã¯è½ã¡ç€ã„ãŸãƒˆãƒ¼ãƒ³ã§èãå½¹ã«ã‚‚å›ã‚Œã¾ã™ã€‚",
  "ã‚µãƒ¼ãƒ­ã‚¤ãƒ³":"è¯ã‚„ãã¨ã‚µãƒ¼ãƒ“ã‚¹ç²¾ç¥ã§å ´ã‚’ç››ã‚Šä¸Šã’ã‚‹ãƒ ãƒ¼ãƒ‰ãƒ¡ãƒ¼ã‚«ãƒ¼ã€‚å†™çœŸæ˜ ãˆã‚„â€œç‰¹è£½ã‚½ãƒ¼ã‚¹â€ã«å¿ƒãŒèºã‚Šã€äººã®è‰¯ã•ã‚’ç´ æ—©ãæ‹¾ã£ã¦åˆã‚ã›ã‚‰ã‚Œã‚‹å™¨ç”¨ã•ã‚‚ã€‚ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¤§ãã‚ã§è¼ªã‚’åºƒã’ã¾ã™ã€‚",
  "ã‚¶ãƒ–ãƒˆãƒ³":"ã—ã£ã¨ã‚Šæ¿ƒåšã€å™›ã‚€ã»ã©ã«åºƒãŒã‚‹ã‚³ã‚¯ã‚’æ„›ã™ã‚‹å¯©ç¾çœ¼ã®æŒã¡ä¸»ã€‚ã“ã ã‚ã‚Šã¯å¼·ã„ãŒæŠ¼ã—ä»˜ã‘ãšã€ä¸å¯§ã«è¨€è‘‰ã‚’é¸ã³ã¾ã™ã€‚å°‘äººæ•°ã§ã˜ã£ãã‚Šè©±ã™ã®ãŒå¥½ãã€‚",
  "ã‚«ãƒ«ãƒ“":"æ¿ƒåšã§ç”˜è¾›ã®æ—¨ã¿ã‚’æ„›ã™ã‚‹ãƒªãƒƒãƒæ´¾ã€‚ã‚µãƒ¼ãƒ“ã‚¹ç²¾ç¥ãŒã‚ã‚Šã€äººã‚’å·»ãè¾¼ã‚€ã®ãŒä¸Šæ‰‹ã€‚ã”è¤’ç¾æ„Ÿã®ã‚ã‚‹ä½“é¨“ã«å¼±ãã€ã¿ã‚“ãªã§ãƒ¯ã‚¤ãƒ¯ã‚¤ç››ã‚Šä¸ŠãŒã‚‹å¤œãŒä¼¼åˆã„ã¾ã™ã€‚",
  "ãƒãƒ©ãƒŸ":"ç‚­ç«ã¨ç”˜è¾›ãƒ€ãƒ¬ãŒä¼¼åˆã†ã€èºå‹•æ„Ÿã®ã‚ã‚‹èµ¤èº«æ´¾ã€‚æ­¯ã”ãŸãˆã‚’æ¥½ã—ã¿ã¤ã¤ã‚¸ãƒ¥ãƒ¼ã‚·ãƒ¼ã•ã‚‚è­²ã‚‰ãªã„å®Ÿåˆ©ã‚¿ã‚¤ãƒ—ã€‚é›£ã—ã„ç†å±ˆã‚ˆã‚Šâ€œã†ã¾ã„ãƒ»ãŸã®ã—ã„â€ã‚’å…±æœ‰ã—ãŸã„äººã€‚",
  "ã‚·ãƒ³ã‚·ãƒ³":"ä¸Šå“ãªèµ¤èº«ã®ã‚³ã‚¯ã¨ã‚­ãƒ¬ã‚’ä¸¡ç«‹ã€‚ç„¡é§„ã®ãªã„å‘³è¨­è¨ˆã‚’å¥½ã¿ã€æ®µå–ã‚Šè‰¯ãå ´ã‚’æ•´ãˆã‚‹å …å®Ÿæ´¾ã€‚é™ã‹ãªé ¼ã‚‚ã—ã•ã§ã€èƒŒä¼¸ã³ã—ãªã„â€œã¡ã‚‡ã†ã©ã„ã„è´…æ²¢â€ã«ã‚»ãƒ³ã‚¹ãŒå…‰ã‚Šã¾ã™ã€‚",
  "ã‚«ã‚¤ãƒãƒŸ":"ã‚«ãƒ«ãƒ“ç³»ã®ä¸­ã§ã‚‚è»½ã‚„ã‹ã§ç¹Šç¶­æ„ŸãŒå¿ƒåœ°ã‚ˆã„éƒ¨ä½ã€‚è„‚ã®æ—¨ã¿ã¯å¥½ãã ãŒé‡ã•ã¯æŠ‘ãˆãŸã„äººã«ãƒ•ã‚£ãƒƒãƒˆã€‚å¡©ã‚„ãƒ¬ãƒ¢ãƒ³ã§ã‚­ãƒ¬è‰¯ãä»•ä¸Šã’ã‚‹é¸æŠçœ¼ãŒé­…åŠ›ã€‚",
  "ãƒŸã‚¹ã‚¸":"ç¹Šç´°ãªã‚µã‚·ãŒå…¥ã‚Šã¤ã¤è»½ã‚„ã‹ã€‚ã‚„ã•ã—ã„å£ã©ã‘ã¨ä¸Šå“ãªé¦™ã‚Šã‚’å¥½ã‚€ä¸å¯§ã•ã®äººã€‚éŸ³ã‚„æ¸©åº¦ãªã©ç´°éƒ¨ã«æ°—ã¥ã‘ã€å°‘äººæ•°ã§ã˜ã£ãã‚Šè©±ã™ã¨é­…åŠ›ãŒèŠ±é–‹ãã¾ã™ã€‚",
  "ã‚·ãƒ£ãƒˆãƒ¼ãƒ–ãƒªã‚¢ãƒ³":"ç¹Šç´°ã•ã¨é›†ä¸­åŠ›ã€ãã—ã¦è³ªã¸ã®å¼·ã„ã“ã ã‚ã‚Šã‚’å‚™ãˆãŸâ€œç‰¹é¸ãƒ’ãƒ¬â€ã€‚é‡ã‚ˆã‚Šè³ªã€æ´¾æ‰‹ã•ã‚ˆã‚Šå®Œæˆåº¦ã‚’é‡ã‚“ã˜ã¾ã™ã€‚æ€¥ãŒãšæ·±ãã€å°‘äººæ•°ã§ã˜ã£ãã‚Šå‘ãåˆã†ã¨ç›¸æ€§ãŒèŠ±é–‹ãå¸Œå°‘ã‚¿ã‚¤ãƒ—ã€‚"
};

/* --------------- State --------------- */
let current=0; let qStartAt=0; const total=BANK.length;
let QUESTIONS=[];
const counts={R:0,L:0,F:0,S:0,K:0,C:0,Q:0,M:0,Salt:0,Sauce:0,Light:0,Hearty:0};
const answers=[]; const rtimes=[]; const rl_items=[]; const fs_items=[]; const kc_items=[];
const el=id=>document.getElementById(id);
const screenStart=el('screen-start'), screenQuiz=el('screen-quiz'), screenResult=el('screen-result');

function showScreen(which){screenStart.hidden=which!=='start';screenQuiz.hidden=which!=='quiz';screenResult.hidden=which!=='result';}
function resetAll(){
  // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹åˆæœŸåŒ–
  el('bar').style.width='0%';
  Object.keys(counts).forEach(k=>counts[k]=0);
  answers.length=0; rtimes.length=0; rl_items.length=0; fs_items.length=0; kc_items.length=0;
  current=0; showScreen('start');
}
function start(){
  resetAll();
  window.gtag && gtag('event','diagnostic_start',{from:'meat-bti'});
  QUESTIONS=decorateBankRandomly([...BANK]).sort(()=>Math.random()-0.5);
  showScreen('quiz');
  el('q-total').textContent=QUESTIONS.length;
  current=0; renderQ();
}

function renderQ(){
  const q=QUESTIONS[current];
  el('q-counter').textContent=current+1;
  const pct=((current)/QUESTIONS.length)*100;
  el('bar').style.width=pct+'%';

  el('q-title').textContent='ã‚ãªãŸã¯ã©ã¡ã‚‰ã«è¿‘ã„ï¼Ÿ';
  const left=q.flip?q.b:q.a; const right=q.flip?q.a:q.b;
  el('ab-left').querySelector('b').textContent=left;
  el('ab-right').querySelector('b').textContent=right;
  el('ab').classList.remove('glow-left','glow-right');

  // è¨ˆæ¸¬ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆä¿¡é ¼åº¦ç”¨ï¼‰
  qStartAt=performance.now();
}

function setHover(dir){
  const ab=el('ab'); ab.classList.remove('glow-left','glow-right');
  if(dir==='L') ab.classList.add('glow-left');
  if(dir==='R') ab.classList.add('glow-right');
}

// 5æŠï¼šå¼·ã„å·¦=+2 / ã‚„ã‚„å·¦=+1 / ä¸­ç«‹=0 / ã‚„ã‚„å³=-1 / å¼·ã„å³=-2
function pickLikert(uiVal){
  const q=QUESTIONS[current];
  const elapsed=performance.now()-qStartAt; rtimes.push(elapsed);
  const valForA=(q.flip?-uiVal:uiVal);
  const weight=v=>v===0?0:(Math.abs(v)===2?1.0:0.5);

  answers.push({id:q.id,axis:q.axis,uiVal,valForA,flipped:q.flip,ms:elapsed});
  const w=weight(valForA), towardA=Math.sign(valForA);
  const add=(k)=>counts[k]=(counts[k]||0)+w;

  if(q.axis==='RL'){towardA>0? (add('R'), rl_items.push(1)) : towardA<0? (add('L'), rl_items.push(0)) : null;}
  if(q.axis==='FS'){towardA>0? (add('F'), fs_items.push(1)) : towardA<0? (add('S'), fs_items.push(0)) : null;}
  if(q.axis==='KC'){towardA>0? (add('K'), kc_items.push(1)) : towardA<0? (add('C'), kc_items.push(0)) : null;}
  if(q.axis==='TX'){towardA>0? add('Q') : towardA<0? add('M') : null;}
  if(q.axis==='FL'){towardA>0? add('Salt') : towardA<0? add('Sauce') : null;}
  if(q.axis==='AF'){towardA>0? add('Light') : towardA<0? add('Hearty') : null;}

  next();
}
function next(){
  if(current<QUESTIONS.length-1){ current++; renderQ(); }
  else{ showResult(); }
}

/* ===== ã‚¿ã‚¤ãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ä¸ä½¿ç”¨ï¼‹ã‚·ãƒ¼ãƒ‰ï¼‰ ===== */
function strongEdge(axis){
  let edge = 0;
  for (const a of answers) {
    if (a.axis !== axis) continue;
    if (a.valForA >= 2) edge += 1;       // Aï¼ˆå·¦ï¼‰ã«å¼·ã
    else if (a.valForA <= -2) edge -= 1; // Bï¼ˆå³ï¼‰ã«å¼·ã
  }
  return edge;
}
function axisSeed(axis){
  let s = 0;
  for (const a of answers) {
    if (axis !== 'ALL' && a.axis !== axis) continue;
    s += (a.id * 31) + ((a.uiVal + 2) * 17);
  }
  return s & 1; // 0 or 1
}
function decideAxis(A_base, B_base, A_label, B_label, relatedA, relatedB, strongAxis, seedBit) {
  if (A_base > B_base) return A_label;
  if (B_base > A_base) return B_label;
  const wA = A_base + relatedA;
  const wB = B_base + relatedB;
  if (wA > wB) return A_label;
  if (wB > wA) return B_label;
  const edge = strongEdge(strongAxis);
  if (edge > 0) return A_label;
  if (edge < 0) return B_label;
  return seedBit ? B_label : A_label; // å®Œå…¨åŒç‚¹ã®æœ€çµ‚æ‰‹æ®µ
}

/* ===== ã‚µãƒ–ã‚¿ã‚¤ãƒ—é¸æŠï¼ˆ8ã‚³ãƒ¼ãƒ‰â†’12ã‚¿ã‚¤ãƒ—ã¸åˆ†å²ï¼‰ ===== */
function scoreHarami(c){ return 0.60*c.Sauce - 0.60*c.Salt + 0.30*c.Hearty - 0.30*c.Light + 0.20*c.M - 0.20*c.Q; }
function scoreMisuji(c){ return 0.70*c.M - 0.70*c.Q + 0.20*c.Salt - 0.20*c.Sauce + 0.10*c.Light - 0.10*c.Hearty; }
function scoreShinshin(c){ return 0.55*c.Q - 0.55*c.M + 0.25*c.Light - 0.25*c.Hearty + 0.20*c.Salt - 0.20*c.Sauce; }
function scoreKainomi(c){ return 0.60*c.Q - 0.60*c.M + 0.30*c.Salt - 0.30*c.Sauce + 0.10*c.Light - 0.10*c.Hearty; }
function pickSubtype(code, c){
  switch(code){
    case 'R-F-K': return 'ãƒ’ãƒ¬';
    case 'R-F-C': return (scoreHarami(c) > 0 ? 'ãƒãƒ©ãƒŸ' : 'ã‚¿ãƒ³');
    case 'R-S-K': return (scoreMisuji(c) > 0 ? 'ãƒŸã‚¹ã‚¸' : 'ã‚¤ãƒãƒœ');
    case 'R-S-C': return 'ãƒ©ãƒ³ãƒ—';
    case 'L-F-K': return (scoreShinshin(c) > 0 ? 'ã‚·ãƒ³ã‚·ãƒ³' : 'ãƒªãƒ–ãƒ­ãƒ¼ã‚¹');
    case 'L-F-C': return 'ã‚µãƒ¼ãƒ­ã‚¤ãƒ³';
    case 'L-S-K': return 'ã‚¶ãƒ–ãƒˆãƒ³';
    case 'L-S-C': return (scoreKainomi(c) > 0 ? 'ã‚«ã‚¤ãƒãƒŸ' : 'ã‚«ãƒ«ãƒ“');
    default: return 'ãƒ’ãƒ¬';
  }
}

/* ---- åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ï¼ˆåŸºæœ¬12ï¼‹ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆCBï¼‰ ---- */
function computeResult(){
  const R_base=counts.R, L_base=counts.L;
  const F=counts.F, S=counts.S;
  const K=counts.K, C=counts.C;

  const Q=counts.Q, M=counts.M;
  const Salt=counts.Salt, Sauce=counts.Sauce;
  const Light=counts.Light, Hearty=counts.Hearty;

  const R_adj=(Q>=2?1:0)+(Salt>=2?1:0)+(Light>=2?1:0);
  const L_adj=(M>=2?1:0)+(Sauce>=2?1:0)+(Hearty>=2?1:0);
  const Rf=R_base+R_adj, Lf=L_base+L_adj;

  const RL = decideAxis(
    Rf, Lf, 'R', 'L',
    0.60*Q + 0.25*Salt + 0.15*Light,
    0.60*M + 0.25*Sauce + 0.15*Hearty,
    'RL',
    axisSeed('RL')
  );
  const FS = decideAxis(
    F, S, 'F', 'S',
    0.50*Light + 0.30*Salt + 0.20*Q,
    0.50*Hearty + 0.30*Sauce + 0.20*M,
    'FS',
    axisSeed('FS')
  );
  const KC = decideAxis(
    K, C, 'K', 'C',
    0.45*Salt + 0.25*Light + 0.15*Q,
    0.45*Sauce + 0.25*Hearty + 0.15*M,
    'KC',
    axisSeed('KC')
  );

  const code=`${RL}-${FS}-${KC}`;
  let baseName = pickSubtype(code, counts);
  let name = baseName;

  // â”€â”€ ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼šã‚·ãƒ£ãƒˆãƒ¼ãƒ–ãƒªã‚¢ãƒ³ï¼ˆå¸Œå°‘ï¼‰
  const dRL = Math.max(0, (RL==='R' ? Rf-Lf : Lf-Rf));
  const dFS = Math.max(0, (FS==='F' ? F-S : S-F));
  const dKC = Math.max(0, (KC==='K' ? K-C : C-K));
  const cbSeed = axisSeed('ALL');
  const isCB = (code==='R-F-K') && (baseName==='ãƒ’ãƒ¬')
    && (M>=2 && Salt>=2 && Light>=2)
    && (dRL>=1.3 && dFS>=1.1 && dKC>=1.0)
    && (strongEdge('RL')>0)
    && (cbSeed===1);
  if (isCB) name='ã‚·ãƒ£ãƒˆãƒ¼ãƒ–ãƒªã‚¢ãƒ³';

  const tagTexture=(Q>=M)?'å™›ã¿å¿œãˆ':'ã¨ã‚ã‘';
  const tagFlavor =(Salt>=Sauce)?'å¡©æ´¾':'ã‚½ãƒ¼ã‚¹æ´¾';
  const tagAfter  =(Light>=Hearty)?'è»½ã‚„ã‹':'æº€è¶³';

  return { code,baseName,name,R_base,L_base,F,S,K,C,Q,M,Salt,Sauce,Light,Hearty,R_adj,L_adj,Rf,Lf,tagTexture,tagFlavor,tagAfter };
}

function parseCode(code){const [a,b,c]=code.split('-');return {RL:a,FS:b,KC:c};}
function allTypeCodes(){return Object.keys(CODE_REPR);}
function bestMatch(code){
  const mine=parseCode(code);let best=null,bestScore=-1;
  for(const t of allTypeCodes()){
    if(t===code) continue; const other=parseCode(t);
    let opp=0,same=0;
    if(other.RL===OPP[mine.RL])opp++; if(other.FS===OPP[mine.FS])opp++; if(other.KC===OPP[mine.KC])opp++;
    if(other.RL===mine.RL)same++; if(other.FS===mine.FS)same++; if(other.KC===mine.KC)same++;
    const score=(opp>=2)?opp*10:(opp*10+same);
    if(score>bestScore){bestScore=score;best=t;}
  }
  return best;
}

/* ---- ä¿¡é ¼åº¦ãƒ­ã‚¸ãƒƒã‚¯ ---- */
function smoothedRatio(a,b,prior=1.2){const p=(a+prior)/(a+b+2*prior);return p;}
function axisConfidence(a,b){const p=smoothedRatio(a,b);return Math.max(p,1-p);}
function kr20(items){const k=items.length;if(k<2)return null;const mean=items.reduce((s,x)=>s+x,0)/k;const vari=items.reduce((s,x)=>s+(x-mean)**2,0)/k;const totalVar=k*mean*(1-mean);if(totalVar===0)return null;return (k/(k-1))*(1-(k*vari)/totalVar);}
function percentile(arr,p){const a=[...arr].sort((x,y)=>x-y);const i=Math.floor((a.length-1)*p);return a[i]??0;}
function qualityAssess(r){
  const confRL=axisConfidence(r.R_base,r.L_base), confFS=axisConfidence(r.F,r.S), confKC=axisConfidence(r.K,r.C);
  const overall=Math.round(((confRL+confFS+confKC)/3)*100);
  const alphaRL=kr20(rl_items), alphaFS=kr20(fs_items), alphaKC=kr20(kc_items);
  const medRT=percentile(rtimes,0.5);
  const tooFast=rtimes.filter(ms=>ms<400).length>=4;
  const posBias=Math.max(answers.filter(a=>a.uiVal>0).length,answers.filter(a=>a.uiVal<0).length)/answers.length;
  let notes=[]; if(alphaRL!==null && alphaRL<0.4) notes.push('R/Lã®å›ç­”ä¸€è²«æ€§ãŒã‚„ã‚„ä½ã„ã‹ã‚‚');
  if(alphaFS!==null && alphaFS<0.4) notes.push('F/Sã®å›ç­”ä¸€è²«æ€§ãŒã‚„ã‚„ä½ã„ã‹ã‚‚');
  if(alphaKC!==null && alphaKC<0.4) notes.push('K/Cã®å›ç­”ä¸€è²«æ€§ãŒã‚„ã‚„ä½ã„ã‹ã‚‚');
  if(tooFast) notes.push('éå¸¸ã«é€Ÿã„å›ç­”ãŒå¤šã„ï¼ˆé€£æ‰“ã®å¯èƒ½æ€§ï¼‰');
  if(posBias>0.8) notes.push('å·¦/å³ã©ã¡ã‚‰ã‹ã«åã£ãŸé¸æŠ');
  return {confRL,confFS,confKC,overall,alphaRL,alphaFS,alphaKC,medRT,tooFast,posBias,notes};
}

function setMeter(id,pct){el(id).style.width=pct+'%';const tId=id+'-text';if(el(tId)) el(tId).textContent=Math.round(pct)+'%';}

function showResult(){
  // é€²æ—ãƒãƒ¼100%
  el('bar').style.width='100%';

  const r=computeResult();
  showScreen('result');
  el('r-type-name').textContent=r.name;
  el('r-type-code').textContent=r.code;
  el('tag-texture').textContent=r.tagTexture;
  el('tag-flavor').textContent=r.tagFlavor;
  el('tag-after').textContent=r.tagAfter;
  el('r-desc').textContent=DESCRIPTIONS[r.name]||'';

  const bm=bestMatch(r.code);
  const repr=CODE_REPR[bm]||bm; el('r-best').textContent=bm?`${repr}ï¼ˆ${bm}ï¼‰`:'â€”';

  const qa=qualityAssess(r);
  setMeter('conf-overall',qa.overall);
  el('conf-overall-text').textContent=`${qa.overall}% ${qa.overall>=75?'ï¼ˆé«˜ï¼‰':qa.overall>=60?'ï¼ˆä¸­ï¼‰':'ï¼ˆä½ï¼‰'}`;
  setMeter('conf-rl',qa.confRL*100); el('conf-rl-text').textContent=`${Math.round(qa.confRL*100)}%`;
  setMeter('conf-fs',qa.confFS*100); el('conf-fs-text').textContent=`${Math.round(qa.confFS*100)}%`;
  setMeter('conf-kc',qa.confKC*100); el('conf-kc-text').textContent=`${Math.round(qa.confKC*100)}%`;

  let hint=[]; if(qa.alphaRL!==null) hint.push(`R/L ä¸€è²«æ€§ Î±=${qa.alphaRL.toFixed(2)}`);
  if(qa.alphaFS!==null) hint.push(`F/S ä¸€è²«æ€§ Î±=${qa.alphaFS.toFixed(2)}`);
  if(qa.alphaKC!==null) hint.push(`K/C ä¸€è²«æ€§ Î±=${qa.alphaKC.toFixed(2)}`);
  hint.push(`ä¸­å¤®å€¤ã®å›ç­”æ™‚é–“ ${Math.round(qa.medRT)}ms`);
  if(qa.notes.length){hint.push('æ³¨æ„: '+qa.notes.join(' / '));}
  el('quality-hints').textContent=hint.join('ã€€');

  const detail=[
    `Code: ${r.code} / Base: ${r.baseName} / Display: ${r.name}`,
    `R/L base: R=${r.R_base.toFixed(1)}, L=${r.L_base.toFixed(1)}  adj: R+${r.R_adj}, L+${r.L_adj}  â†’ Rf=${r.Rf.toFixed(1)}, Lf=${r.Lf.toFixed(1)}`,
    `F/S: F=${r.F.toFixed(1)}, S=${r.S.toFixed(1)}`,
    `K/C: K=${r.K.toFixed(1)}, C=${r.C.toFixed(1)}`,
    `Texture: Q=${r.Q.toFixed(1)}, M=${r.M.toFixed(1)}  Flavor: Salt=${r.Salt.toFixed(1)}, Sauce=${r.Sauce.toFixed(1)}  After: Light=${r.Light.toFixed(1)}, Hearty=${r.Hearty.toFixed(1)}`,
    `Tags: ${r.tagTexture}ãƒ»${r.tagFlavor}ãƒ»${r.tagAfter}`
  ].join('\n');
  el('r-detail').textContent=detail;

  const payload={
    type:{baseCode:r.code,baseName:r.baseName,displayName:r.name},
    tags:{texture:r.tagTexture,flavor:r.tagFlavor,after:r.tagAfter},
    counts:{R:r.R_base,L:r.L_base,F:r.F,S:r.S,K:r.K,C:r.C,Q:r.Q,M:r.M,Salt:r.Salt,Sauce:r.Sauce,Light:r.Light,Hearty:r.Hearty},
    adjusted:{Rf:r.Rf,Lf:r.Lf,R_adj:r.R_adj,L_adj:r.L_adj},
    quality:qa,answers,generatedAt:new Date().toISOString()
  };
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=el('btn-export'); a.href=url; a.download=`MEAT-BTI_${r.code}.json`;
}

async function copyResult(){
  const name=el('r-type-name').textContent;
  const code=el('r-type-code').textContent;
  const tags=[el('tag-texture').textContent,el('tag-flavor').textContent,el('tag-after').textContent].join('ãƒ»');
  const text=`MEAT-BTI v7.2ï¼ˆæ™‚é–“åˆ¶é™ãªã—ï¼‰\néƒ¨ä½ã‚¿ã‚¤ãƒ—ï¼š${name}ï¼ˆ${code}ï¼‰\nã‚¿ã‚°ï¼š${tags}`;
  try{await navigator.clipboard.writeText(text); el('btn-copy').textContent='ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'; setTimeout(()=>el('btn-copy').textContent='çµæœã‚’ã‚³ãƒ”ãƒ¼',1500);}catch{alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');}
}

// Startï¼ˆ#btn-start / #btn-start-2 / data-action="start"ï¼‰
addEventListener('click',(ev)=>{
  const t=ev.target.closest('#btn-start, #btn-start-2, [data-action="start"]'); if(!t) return;
  ev.preventDefault(); start();
});

// hoverã§å·¦å³ã®ã‚«ãƒ¼ãƒ‰ã«ã‚°ãƒ­ãƒ¼ï¼ˆã‚¯ãƒªãƒƒã‚¯ã¯ç„¡åŠ¹ï¼‰
['1','2','3','4','5'].forEach(i=>{
  document.getElementById('btn-'+i).addEventListener('mouseenter',()=>{
    if(i==='1'||i==='2') setHover('L'); else if(i==='4'||i==='5') setHover('R'); else setHover();
  });
  document.getElementById('btn-'+i).addEventListener('mouseleave',()=>setHover());
  document.getElementById('btn-'+i).addEventListener('click',e=>pickLikert(Number(e.currentTarget.dataset.val)));
});

// å·¦å³ã‚«ãƒ¼ãƒ‰ã®ã‚¯ãƒªãƒƒã‚¯ã¯ä»˜ä¸ã—ãªã„ï¼ˆç„¡åŠ¹åŒ–ï¼‰
// el('ab-left').addEventListener('click',...);  // â† å‰Šé™¤
// el('ab-right').addEventListener('click',...); // â† å‰Šé™¤

const retry=document.getElementById('btn-retry'); if(retry) retry.addEventListener('click',resetAll);
const copy=document.getElementById('btn-copy'); if(copy) copy.addEventListener('click',copyResult);

// keyboard shortcuts 1..5
window.addEventListener('keydown',e=>{
  if(screenQuiz.hidden) return;
  const map={'1':2,'2':1,'3':0,'4':-1,'5':-2};
  if(map[e.key]!==undefined) pickLikert(map[e.key]);
});

showScreen('start');
</script>
</body>
</html>
