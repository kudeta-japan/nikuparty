<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MEAT-BTI v8（テスト版・sub.html）｜20問・6択／多軸加点</title>
<meta name="description" content="20問・6段階で“部位タイプ”を判定。順番固定＆多軸加点（R/L・Q/M・F/S・K/C）。おすすめ4割／相性6割で結果表示。12タイプ：シンシンを廃止しシャトーブリアン採用。">
<meta name="theme-color" content="#0a0d14">

<style>
  :root{
    --bg:#090b10; --panel:#0f1219; --ink:#f5f8ff; --muted:#b7c3d6;
    --acc:#ff715b; --acc2:#ffd166; --bd:#1b2030; --shadow:0 10px 30px rgba(0,0,0,.35);
    --grad: radial-gradient(1200px 600px at 10% -10%, rgba(255,113,91,.25), transparent 40%),
            radial-gradient(1200px 600px at 110% 110%, rgba(255,209,102,.2), transparent 40%),
            linear-gradient(180deg,#0a0d14,#0b0e15 50%, #0d111a);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Meiryo",sans-serif;letter-spacing:.02em;line-height:1.65}
  .app{width:min(980px,96vw);margin:0 auto;padding:20px}
  .card{background:var(--panel);border:1px solid var(--bd);border-radius:20px;box-shadow:var(--shadow);overflow:hidden}
  header.appbar{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border:1px solid var(--bd);border-radius:16px;background:#0c1019;margin-top:14px}
  .brand{display:flex;align-items:center;gap:10px;font-weight:900}
  .logo{width:36px;height:36px;border-radius:10px;background:conic-gradient(from 140deg,var(--acc),var(--acc2));display:grid;place-items:center;color:#111}
  .btn{appearance:none;border:1px solid var(--bd);background:#151a23;color:var(--ink);padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer;transition:transform .06s ease, box-shadow .15s ease}
  .btn:hover{transform:translateY(-1px)}
  .btn.primary{background:linear-gradient(180deg,var(--acc),#ff4e36);color:#111;border:none;box-shadow:0 12px 26px rgba(255,113,91,.35)}

  /* HERO：常時表示。テキストは下部に寄せ、画像の下側を見せる */
  .hero{position:relative;margin-top:16px;border-radius:20px;overflow:hidden;border:1px solid var(--bd)}
  .hero-img{width:100%;height:clamp(320px,56vh,520px);object-fit:cover;object-position:center 82%;display:block;filter:brightness(.86) contrast(1.05)}
  .hero::after{content:"";position:absolute;inset:0;background:linear-gradient(180deg,transparent 40%, rgba(0,0,0,.65) 100%)}
  .hero-copy{position:absolute;left:0;right:0;bottom:0;padding:20px 18px 16px 18px}
  .eyebrow{display:inline-flex;gap:8px;align-items:center;background:rgba(255,255,255,.08);border:1px solid #222a3a;color:#dfe7f5;padding:6px 10px;border-radius:999px;font-size:12px}
  .h1{font-size:clamp(24px,5.2vw,38px);line-height:1.25;font-weight:900;margin:8px 0 0}
  .lead{color:var(--muted);margin:6px 0 0}
  .cta-row{display:flex;align-items:center;gap:12px;margin-top:10px;flex-wrap:wrap}
  .types{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px}
  @media(min-width:720px){.types{grid-template-columns:repeat(6,1fr)}}
  .type-chip{background:#121726;border:1px solid #2a3140;border-radius:12px;padding:8px 10px;text-align:center;font-weight:700;white-space:nowrap}

  /* QUIZ */
  .wrap{margin-top:16px}
  .section{padding:16px}
  .q-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .q-index{font-weight:900}
  .bar{height:6px;background:#141721;border:1px solid var(--bd);border-radius:999px;overflow:hidden;width:220px}
  .bar>div{height:100%;width:0%;background:linear-gradient(90deg,var(--acc),var(--acc2))}
  .qgrid{display:grid;gap:12px}
  .qitem{background:#111522;border:1px solid #2a3140;border-radius:14px;padding:14px}
  .ctx{color:#e7ecf8;font-weight:700;font-size:clamp(14px,2.8vw,16px);margin:-2px 0 8px 0}
  .lr{display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:stretch;pointer-events:none}
  .side{background:#0f1522;border:1px solid #272f41;border-radius:12px;padding:10px;min-height:66px;display:flex;align-items:center;justify-content:center;text-align:center}
  .side b{font-size:clamp(14px,2.6vw,17px)}
  .scale{display:flex;gap:10px;justify-content:center;align-items:center;margin-top:10px}
  .dot{width:28px;height:28px;border-radius:999px;border:2px solid #39435a;background:#161b27;cursor:pointer;display:grid;place-items:center}
  .dot.small{width:22px;height:22px}
  .dot.big{width:32px;height:32px}
  .dot[data-side="L"].active{background:linear-gradient(180deg,#3aa1ff,#2677c8);border-color:#2b6fb6;box-shadow:0 0 0 4px rgba(63,155,255,.18)}
  .dot[data-side="R"].active{background:linear-gradient(180deg,#ff7a63,#ff5039);border-color:#e6422e;box-shadow:0 0 0 4px rgba(255,104,84,.18)}
  .dot:hover{transform:translateY(-1px)}
  .q-foot{display:flex;justify-content:space-between;align-items:center;margin-top:8px;color:var(--muted);font-size:12px}
  .disabled{opacity:.55;pointer-events:none}
  .progress-note{color:var(--muted);font-size:12px;text-align:center;margin-top:8px}

  /* RESULT（相性6割：おすすめ4割） */
  .result{display:grid;gap:16px}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}
  @media(min-width:720px){.grid-compat-heavy{grid-template-columns:1fr 1.4fr}}
  .r-card{background:#0f1219;border:1px solid var(--bd);border-radius:14px;padding:14px}
  .big{font-size:clamp(26px,6vw,34px);font-weight:900}
  .desc{margin-top:10px;line-height:1.9}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .pill{display:inline-block;padding:6px 12px;border-radius:999px;background:#131726;border:1px solid var(--bd);margin-right:6px}
  footer{padding:10px 0 30px;color:var(--muted);font-size:12px;text-align:center}
</style>
</head>
<body>
<main class="app">
  <header class="appbar">
    <div class="brand"><div class="logo">🥩</div><div>MEAT-BTI v8（テスト）</div></div>
    <button id="btn-start" class="btn primary">診断をはじめる</button>
  </header>

  <!-- HERO（常時表示） -->
  <section class="hero" aria-label="hero">
    <img src="mbti.jpg" alt="MEAT-BTI" class="hero-img">
    <div class="hero-copy">
      <span class="eyebrow">20問・6段階／順番固定・多軸加点</span>
      <h1 class="h1">肉好きのための性格診断。あなたはどの“部位タイプ”？</h1>
      <p class="lead">A/Bの選択でも、複数要素（R/L・Q/M・F/S・K/C）に同時加点。</p>
      <div class="cta-row">
        <button id="btn-start-2" class="btn primary">診断をはじめる</button>
        <span style="color:var(--muted);font-size:12px">※キーボード <b>1–6</b> でも選択可能</span>
      </div>
      <div class="types" aria-label="12タイプ">
        <div class="type-chip">ヒレ</div><div class="type-chip">タン</div><div class="type-chip">イチボ</div><div class="type-chip">ランプ</div>
        <div class="type-chip">リブロース</div><div class="type-chip">サーロイン</div><div class="type-chip">ザブトン</div><div class="type-chip">カルビ</div>
        <div class="type-chip">ハラミ</div><div class="type-chip">シャトーブリアン</div><div class="type-chip">カイノミ</div><div class="type-chip">ミスジ</div>
      </div>
    </div>
  </section>

  <!-- QUIZ -->
  <section id="screen-quiz" class="section card" hidden>
    <div class="q-head">
      <div class="q-index"><span id="page-now">1</span>/4ページ（<span id="q-answered">0</span>/20）</div>
      <div class="bar"><div id="bar"></div></div>
    </div>

    <div id="qgrid" class="qgrid"><!-- 5問をレンダー --></div>

    <div class="q-foot">
      <div>丸いドットで選択。左（青）⇔右（赤）ほど強い。</div>
      <div><button id="btn-next" class="btn primary disabled">次の5問へ</button></div>
    </div>
    <div class="progress-note">※ 1～6キーでも入力できます（1=左強・6=右強）</div>
  </section>

  <!-- RESULT（相性6割／おすすめ4割） -->
  <section id="screen-result" class="section" hidden>
    <div class="result">
      <div class="big">診断結果</div>
      <div class="grid grid-compat-heavy">
        <!-- 左：あなたのタイプ & おすすめ（約4割） -->
        <div class="r-card">
          <div><strong>あなたの部位タイプ</strong></div>
          <div style="margin-top:6px;font-size:22px;font-weight:900" id="r-type-name">—</div>
          <div class="mono" id="r-type-code" style="opacity:.8">R-F-K</div>
          <div style="margin-top:10px">
            <span class="pill" id="tag-texture">噛み応え</span>
            <span class="pill" id="tag-flavor">塩寄り</span>
            <span class="pill" id="tag-after">テンポ重視</span>
          </div>
          <p class="desc" id="r-desc"></p>

          <div style="margin-top:10px">
            <strong>おすすめの一皿</strong>
            <ul id="r-recs" style="margin:6px 0 0 18px; padding:0"></ul>
          </div>
        </div>

        <!-- 右：相性ガイド（約6割） -->
        <div class="r-card">
          <div><strong>相性ガイド（トップ3）</strong></div>
          <ol id="compat-list" style="margin:8px 0 0 18px; padding:0"></ol>
          <div id="compat-notes" style="margin-top:10px;color:#cfd7e6;opacity:.9;font-size:12px"></div>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;gap:10px;margin-top:8px">
        <button class="btn" id="btn-retry">最初から</button>
        <a class="btn primary" href="#" id="btn-export" download>結果をJSONで保存</a>
      </div>
    </div>
  </section>

  <footer>© ニクパーティ / MEAT-BTI v8（テスト）</footer>
</main>

<script>
/* =========================================================
   v8 テスト版（sub.html）
   - 順番固定・左右固定
   - 多軸加点（R/L・Q/M・F/S・K/C）…1回答で複数要素に寄与
   - 12タイプ：シンシン→シャトーブリアン
   - 結果表示：おすすめ4割／相性6割（相性トップ3）
   ========================================================= */

/* ===== 20問：何の話か明記、順番固定 ===== */
const BANK = [
  /* Lean vs Rich（4問） */
  {id:1,  ctx:"焼肉の最初の一皿は？", a:"塩タンでスタート", b:"サーロイン/カルビなど“コク系”",
    wA:{R:1.0,F:0.5,K:0.4,Q:0.3}, wB:{L:1.0,S:0.4,C:0.4,M:0.2}},
  {id:2,  ctx:"同じ価格ならどっち？", a:"赤身の旨み", b:"霜降りのコク",
    wA:{R:1.0}, wB:{L:1.0}},
  {id:3,  ctx:"デートの夜。肉の方向性は？", a:"軽やかに“赤身中心”で", b:"満足感重視で“霜降り中心”で",
    wA:{R:1.0,F:0.3,K:0.3}, wB:{L:1.0,S:0.3,C:0.3}},
  {id:4,  ctx:"みんなでシェアするなら？", a:"赤身の盛り合わせ", b:"サーロイン/霜降りの盛り合わせ",
    wA:{R:1.0,F:0.2}, wB:{L:1.0,S:0.2}},

  /* Texture（4問） */
  {id:5,  ctx:"“柔らかさ”の理想は？", a:"噛むと心地よい弾力（歯切れ）", b:"口の中でとろける口どけ",
    wA:{Q:1.0}, wB:{M:1.0}},
  {id:6,  ctx:"ステーキの焼き加減は？", a:"レア寄り", b:"ミディアム以上",
    wA:{Q:0.8,R:0.2}, wB:{M:0.8,L:0.2}},
  {id:7,  ctx:"焼肉の“厚み”は？", a:"薄切りでサッと焼く", b:"厚切りでじっくり焼く",
    wA:{Q:0.7,F:0.5}, wB:{M:0.7,S:0.5}},
  {id:8,  ctx:"味付けの“最初の一口”は？", a:"塩・レモン", b:"特製ダレ",
    wA:{R:0.6,K:0.5}, wB:{L:0.6,C:0.5}},

  /* Tempo（4問） */
  {id:9,  ctx:"焼くテンポは？", a:"強火でテンポ良く回す", b:"弱〜中火でじっくり",
    wA:{F:1.0}, wB:{S:1.0}},
  {id:10, ctx:"注文スタイルは？", a:"食べたい物を都度テンポ良く追加", b:"コースでゆっくり進行",
    wA:{F:1.0,K:0.2}, wB:{S:1.0,C:0.2}},
  {id:11, ctx:"混んできたら？", a:"別の店へ移動する", b:"気に入れば腰を据える",
    wA:{F:0.9}, wB:{S:0.9}},
  {id:12, ctx:"役割は？", a:"テキパキ仕切って回す", b:"皆のペースに合わせる",
    wA:{F:0.8,K:0.2}, wB:{S:0.8}},

  /* Keep vs Challenge（4問） */
  {id:13, ctx:"最初に頼むなら？", a:"塩タンなど“定番”", b:"限定・創作メニュー",
    wA:{K:1.0}, wB:{C:1.0}},
  {id:14, ctx:"シェア注文の段取りは？", a:"最初にまとめて段取り", b:"様子を見ながら追加",
    wA:{K:0.9,F:0.4}, wB:{C:0.9,S:0.3}},
  {id:15, ctx:"テーブルの雰囲気づくりは？", a:"マナー重視で落ち着いて", b:"自由にワイワイ",
    wA:{K:0.8,S:0.2}, wB:{C:0.8,F:0.3}},
  {id:16, ctx:"写真も撮る夜なら？", a:"味が最優先", b:"“映え”を優先",
    wA:{K:0.9}, wB:{C:0.9}},

  /* Hybrid（4問） */
  {id:17, ctx:"合わせ方は？", a:"ワイン等で単品を楽しむ", b:"白ごはんでがっつり",
    wA:{R:0.6,K:0.3}, wB:{L:0.6,S:0.2}},
  {id:18, ctx:"締めの一品は？", a:"スープ/冷麺など軽め", b:"ビビンバ/クッパで満腹まで",
    wA:{F:0.4,R:0.3}, wB:{S:0.6,L:0.4}},
  {id:19, ctx:"名物を1皿だけ選ぶなら？", a:"赤身の名物", b:"サーロイン等“コク系”の名物",
    wA:{R:1.0}, wB:{L:1.0}},
  {id:20, ctx:"2回目のデートなら？", a:"肉バルで落ち着いて会話", b:"焼肉で一気に距離を縮める",
    wA:{K:0.6,S:0.3,R:0.2}, wB:{C:0.7,F:0.4,L:0.2}},
];

/* ===== 状態とUI ===== */
const PAGE_SIZE=5, TOTAL_PAGES=4;
let QUESTIONS=[], page=0, responses={}, answeredCount=0, pageStartAt=0;
const counts={R:0,L:0,F:0,S:0,K:0,C:0,Q:0,M:0};
const answers=[], rtimes=[];
const el=id=>document.getElementById(id);
const screenQuiz=el('screen-quiz'), screenResult=el('screen-result');

function showQuiz(){ screenQuiz.hidden=false; screenResult.hidden=true; }
function showResultScreen(){ screenQuiz.hidden=true; screenResult.hidden=false; }

function renderDots(qid){
  const tipsL=["左：とても近い","左：かなり近い","左：やや近い"];
  const tipsR=["右：やや近い","右：かなり近い","右：とても近い"];
  const valsL=[3,2,1], valsR=[-1,-2,-3];
  const cur=responses[qid]?.uiVal;
  const left=valsL.map((v,i)=>`<button class="dot ${i===0?'big':i===1?'':'small'} ${cur===v?'active':''}" data-side="L" data-val="${v}" title="${tipsL[i]}" aria-label="${tipsL[i]}"></button>`);
  const right=valsR.map((v,i)=>`<button class="dot ${i===2?'big':i===1?'':'small'} ${cur===v?'active':''}" data-side="R" data-val="${v}" title="${tipsR[i]}" aria-label="${tipsR[i]}"></button>`);
  return [...left, ...right];
}

/* 開始 */
function start(){
  Object.keys(counts).forEach(k=>counts[k]=0);
  responses={}; answeredCount=0; page=0; answers.length=0; rtimes.length=0;
  QUESTIONS=[...BANK]; // 順番固定
  showQuiz();
  renderPage();
}

/* ページレンダー */
function renderPage(){
  el('page-now').textContent=page+1;
  el('q-answered').textContent=answeredCount;
  el('bar').style.width=((page)/TOTAL_PAGES*100)+'%';

  const startIdx=page*PAGE_SIZE;
  const slice=QUESTIONS.slice(startIdx, startIdx+PAGE_SIZE);

  const grid=el('qgrid'); grid.innerHTML='';
  slice.forEach((q)=>{
    const wrap=document.createElement('div'); wrap.className='qitem'; wrap.dataset.qid=q.id;
    wrap.innerHTML=`
      <div class="ctx">${q.ctx}</div>
      <div class="lr" aria-label="左右の比較文">
        <div class="side"><b>${q.a}</b></div>
        <div class="side"><b>${q.b}</b></div>
      </div>
      <div class="scale" role="radiogroup" aria-label="6段階選択">
        ${renderDots(q.id).join('')}
      </div>
    `;
    grid.appendChild(wrap);
  });

  setNextEnabled(slice.every(q=>responses[q.id]));

  grid.querySelectorAll('.dot').forEach(dot=>{
    dot.addEventListener('click', e=>{
      const qid = Number(e.currentTarget.closest('.qitem').dataset.qid);
      const uiVal = Number(e.currentTarget.dataset.val); // +3..-3
      selectDot(qid, uiVal, e.currentTarget);
    });
  });

  // 1..6 のキー割当（このページの未回答に順次適用）
  window.onkeydown=(e)=>{
    const map={'1':3,'2':2,'3':1,'4':-1,'5':-2,'6':-3};
    if(!(e.key in map)) return;
    for(const q of slice){
      if(!responses[q.id]){
        const qwrap=grid.querySelector(`[data-qid="${q.id}"]`);
        const target=qwrap.querySelector(`.dot[data-val="${map[e.key]}"]`);
        target && target.click(); break;
      }
    }
  };

  pageStartAt=performance.now();
}

function selectDot(qid, uiVal, btn){
  responses[qid] = responses[qid] || {};
  const firstTime = (responses[qid].uiVal === undefined);
  responses[qid].uiVal = uiVal;
  if(firstTime){
    responses[qid].ts = performance.now() - pageStartAt;
    answeredCount++; el('q-answered').textContent = answeredCount;
  }
  const wrap=btn.closest('.qitem');
  wrap.querySelectorAll('.dot').forEach(d=>d.classList.remove('active'));
  wrap.querySelector(`.dot[data-val="${uiVal}"]`).classList.add('active');

  const startIdx=page*PAGE_SIZE; const slice=QUESTIONS.slice(startIdx, startIdx+PAGE_SIZE);
  setNextEnabled(slice.every(q=>responses[q.id]));
}

function setNextEnabled(ok){ el('btn-next').classList.toggle('disabled', !ok); }

/* ページ確定：多軸加点 */
function applyPage(){
  const startIdx=page*PAGE_SIZE; const slice=QUESTIONS.slice(startIdx, startIdx+PAGE_SIZE);
  for(const q of slice){
    const r=responses[q.id]; if(!r) continue;
    const abs=Math.abs(r.uiVal); const towardA=Math.sign(r.uiVal);
    const mag = abs>=3?1.0 : abs===2?0.7 : 0.4;  // 強度スケール
    const vec = (towardA>0) ? q.wA : q.wB;       // A側 or B側 重み
    for(const k of Object.keys(vec)){
      counts[k] = (counts[k]||0) + (vec[k]||0)*mag;
    }
    answers.push({id:q.id,uiVal:r.uiVal,ms:r.ts,ctx:q.ctx});
    rtimes.push(r.ts);
  }
}

/* 次ページ / 結果へ */
document.getElementById('btn-next').addEventListener('click', ()=>{
  const btn = document.getElementById('btn-next');
  if(btn.classList.contains('disabled')) return;
  applyPage();
  if(page < TOTAL_PAGES-1){ page++; renderPage(); }
  else{ showResult(); }
});

/* ===== タイプ定義（12種：シンシン→シャトーブリアン） ===== */
const OPP={R:"L",L:"R",F:"S",S:"F",K:"C",C:"K"};
const CODE_REPR={
  "R-F-K":"ヒレ","R-F-C":"タン","R-S-K":"イチボ","R-S-C":"ランプ",
  "L-F-K":"リブロース","L-F-C":"サーロイン","L-S-K":"ザブトン","L-S-C":"カルビ"
};
const DESCRIPTIONS={
  "ヒレ":"無駄のない上品さと芯の強さ。素材勝負でストレートに味わうタイプ。",
  "タン":"さっぱり塩でキレ良く。テンポの良さと明るさで場をほぐす。",
  "イチボ":"赤身を丁寧に。控えめだが芯あり、余韻を大事にする通好み。",
  "ランプ":"定番を一歩更新する工夫が好き。静かな情熱の実験派。",
  "リブロース":"王道リッチ。段取り良く皆を導ける頼れる人。",
  "サーロイン":"華やぎとサービス精神。写真映えや特製ソースに心が躍る。",
  "ザブトン":"濃厚しっとり。言葉を丁寧に選ぶ審美眼タイプ。",
  "カルビ":"甘辛濃厚を愛するムードメーカー。ワイワイに強い。",
  "ハラミ":"赤身派の躍動感。実利的で“うまい・たのしい”を共有したい。",
  "カイノミ":"軽やかなカルビ系。塩やレモンでキレ良く仕上げたい人に。",
  "ミスジ":"繊細なサシとやさしい口どけ。少人数でじっくりで映える。",
  "シャトーブリアン":"量より質、完成度重視の希少タイプ。少人数で深く。"
};
const RECS={
  "ヒレ":["ヒレの厚切りレア","わさび塩","赤ワイン合わせ"],
  "タン":["上タン塩レモン","ねぎ塩タン","ハイボール合わせ"],
  "イチボ":["イチボ薄切りさっと炙り","山わさび","軽い赤"],
  "ランプ":["ランプのロースト風","柚子胡椒","クラフトビール"],
  "リブロース":["リブロースのサッと焼き","卵黄ダレ","赤ワイン"],
  "サーロイン":["サーロイン薄切り","ガリバタ醤油","濃い赤"],
  "ザブトン":["ザブトン網焼き","山椒塩","ボディある赤"],
  "カルビ":["特製ダレのカルビ","白ごはん","ビール"],
  "ハラミ":["ハラミタレ焼き","にんにくチップ","レモンサワー"],
  "カイノミ":["カイノミ塩","レモン","軽めの赤"],
  "ミスジ":["ミスジ薄切り","ポン酢おろし","日本酒"],
  "シャトーブリアン":["厚切りレア","塩＋黒胡椒のみ","シャンパーニュ/泡"]
};

/* 12タイプ化：ベース8タイプに Texture で分岐（シンシン→シャトーブリアン） */
function pickSubtype(code,c){
  switch(code){
    case 'R-F-K': return 'ヒレ';
    case 'R-F-C': return (c.M>c.Q ? 'ハラミ':'タン');
    case 'R-S-K': return (c.M>c.Q ? 'ミスジ':'イチボ');
    case 'R-S-C': return 'ランプ';
    case 'L-F-K': return (c.M>c.Q ? 'シャトーブリアン':'リブロース');
    case 'L-F-C': return 'サーロイン';
    case 'L-S-K': return 'ザブトン';
    case 'L-S-C': return (c.Q>c.M ? 'カイノミ':'カルビ');
    default: return 'ヒレ';
  }
}

function parseCode(code){const [a,b,c]=code.split('-');return {RL:a,FS:b,KC:c};}
function allTypeCodes(){return Object.keys(CODE_REPR);}

/* 相性（60%補完 + 40%共有） */
function compatScore(myCode, otherCode){
  const me=parseCode(myCode), ot=parseCode(otherCode);
  let opp=0, same=0;
  if(ot.RL===OPP[me.RL]) opp++; else if(ot.RL===me.RL) same++;
  if(ot.FS===OPP[me.FS]) opp++; else if(ot.FS===me.FS) same++;
  if(ot.KC===OPP[me.KC]) opp++; else if(ot.KC===me.KC) same++;
  return 0.6*(opp/3) + 0.4*(same/3);
}
function topMatches(code, n=3){
  return allTypeCodes()
    .filter(c=>c!==code)
    .map(c=>({code:c, score:compatScore(code,c)}))
    .sort((a,b)=>b.score-a.score)
    .slice(0,n);
}

/* 判定 */
function decide(A,B,AL,BL){ return (A>=B)?AL:BL; }
function computeResult(){
  const {R,L,F,S,K,C,Q,M} = counts;
  const RL = decide(R,L,'R','L');
  const FS = decide(F,S,'F','S');
  const KC = decide(K,C,'K','C');
  const code = `${RL}-${FS}-${KC}`;
  const name = pickSubtype(code, {Q,M});
  const tagTexture = (Q>=M)?'噛み応え':'とろけ';
  const tagFlavor  = (R>=L)?'塩寄り':'タレ寄り';
  const tagAfter   = (F>=S)?'テンポ重視':'じっくり重視';
  return {code,name,R,L,F,S,K,C,Q,M,tagTexture,tagFlavor,tagAfter};
}

/* 結果表示（相性6割／おすすめ4割） */
function showResult(){
  el('bar').style.width='100%';
  const r=computeResult();
  showResultScreen();

  // 左カード
  document.getElementById('r-type-name').textContent=r.name;
  document.getElementById('r-type-code').textContent=r.code;
  document.getElementById('tag-texture').textContent=r.tagTexture;
  document.getElementById('tag-flavor').textContent=r.tagFlavor;
  document.getElementById('tag-after').textContent=r.tagAfter;
  document.getElementById('r-desc').textContent=DESCRIPTIONS[r.name]||'';

  const recUL = document.getElementById('r-recs');
  recUL.innerHTML = '';
  (RECS[r.name]||[]).slice(0,3).forEach(txt=>{
    const li=document.createElement('li'); li.textContent=txt; recUL.appendChild(li);
  });

  // 右カード：相性トップ3
  const tops = topMatches(r.code,3);
  const ol = document.getElementById('compat-list'); ol.innerHTML='';
  tops.forEach((t,i)=>{
    const li=document.createElement('li');
    const otherName = CODE_REPR[t.code] || t.code;
    const pct = Math.round(t.score*100);
    const me=parseCode(r.code), ot=parseCode(t.code);
    const bits=[];
    if(ot.RL===OPP[me.RL]) bits.push('赤身/コクが補完'); else if(ot.RL===me.RL) bits.push('味の方向性が一致');
    if(ot.FS===OPP[me.FS]) bits.push('テンポが補完');    else if(ot.FS===me.FS) bits.push('食事速度が合う');
    if(ot.KC===OPP[me.KC]) bits.push('定番/創作のバランス'); else if(ot.KC===me.KC) bits.push('価値観が近い');
    li.innerHTML = `<div style="display:flex;justify-content:space-between;gap:8px">
      <div><strong>${i+1}. ${otherName}</strong>（${t.code}）</div>
      <div class="mono" style="opacity:.85">${pct}%</div>
    </div>
    <div style="color:#cfd7e6;opacity:.9;margin-top:4px">・${bits.join('／')}</div>`;
    ol.appendChild(li);
  });
  document.getElementById('compat-notes').textContent = '※相性は「補完（反対軸）」6割＋「共有（同じ軸）」4割で算出。';

  // JSONエクスポート
  const payload={
    type:{baseCode:r.code,displayName:r.name},
    tags:{texture:r.tagTexture,flavor:r.tagFlavor,after:r.tagAfter},
    counts:{R:r.R,L:r.L,F:r.F,S:r.S,K:r.K,C:r.C,Q:r.Q,M:r.M},
    topMatches: tops,
    answers,
    generatedAt:new Date().toISOString()
  };
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.getElementById('btn-export'); a.href=url; a.download=`MEAT-BTI_${r.code}.json`;
}

/* Start / Retry（個別にバインド：イベント委譲なしで確実発火） */
document.getElementById('btn-start').addEventListener('click', (e)=>{ e.preventDefault(); start(); window.scrollTo({top:screenQuiz.offsetTop-8,behavior:'smooth'}); });
document.getElementById('btn-start-2').addEventListener('click', (e)=>{ e.preventDefault(); start(); window.scrollTo({top:screenQuiz.offsetTop-8,behavior:'smooth'}); });
const retry=document.getElementById('btn-retry'); if(retry) retry.addEventListener('click',()=>{window.scrollTo({top:0,behavior:'smooth'}); location.reload();});
</script>
</body>
</html>
